<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tespit Bildirimi â€¢ Spradon Evleri</title>
  <style>
    :root{
      --bg:#f3f5f7; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --blue:#2563eb; --blue2:#1d4ed8; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700}
    .brand .logo{
      width:34px;height:34px;border-radius:10px;background:#111827; color:#fff;
      display:grid;place-items:center;font-weight:800
    }
    .userbox{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px}
    .chip{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px;
    }
    h1{font-size:18px;margin:0}
    .sub{margin:4px 0 0; color:var(--muted); font-size:12px}
    .sectionTitle{display:flex; align-items:center; gap:8px; font-weight:700; margin-bottom:10px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:560px){ .row{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    select,input,textarea{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      outline:none; font-size:14px; background:#fff
    }
    textarea{min-height:90px; resize:vertical}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:0; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:700;
      background:var(--blue); color:#fff
    }
    .btn:hover{background:var(--blue2)}
    .btn.secondary{background:#eef2ff;color:#1f2937;border:1px solid #c7d2fe}
    .btn.danger{background:var(--bad)}
    .btn.ghost{background:#fff;color:#111827;border:1px solid var(--border)}
    .mini{font-size:12px;color:var(--muted); margin-top:10px}
    .pillRow{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0}
    .pill{
      border:1px solid var(--border); background:#fff; border-radius:999px; padding:8px 10px;
      cursor:pointer; user-select:none; font-size:13px
    }
    .pill.active{border-color:#93c5fd;background:#eff6ff}
    .statusHint{font-size:12px;color:var(--muted); margin-top:8px}

    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:18px;
      background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px;
      box-shadow:var(--shadow); display:none; z-index:9999;
    }
    .toast.show{display:block}

    /* Drawer (Malzeme Talebi) */
    .drawerOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:9000;
    }
    .drawerOverlay.show{display:block}
    .drawer{
      position:fixed; top:0; right:0; height:100%; width:min(520px, 92vw);
      background:#fff; border-left:1px solid var(--border); box-shadow:var(--shadow);
      transform:translateX(110%); transition:.25s ease; z-index:9001;
      display:flex; flex-direction:column;
    }
    .drawer.show{transform:translateX(0)}
    .drawerHeader{
      padding:14px 14px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px
    }
    .drawerHeader strong{font-size:15px}
    .drawerBody{padding:14px; overflow:auto}
    .drawerFooter{
      border-top:1px solid var(--border); padding:12px 14px; background:#fafafa;
      display:flex; gap:10px; justify-content:flex-end;
    }
    .kpi{
      display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px
    }
    .kpi .box{border:1px dashed var(--border); border-radius:14px; padding:10px; color:var(--muted); font-size:12px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:14px 0}
    .smallLink{font-size:12px; color:var(--blue); text-decoration:none}
    .smallLink:hover{text-decoration:underline}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <h1>Tespit Bildirimi</h1>
        <div class="sub">Tespit â†’ ilgili birime dÃ¼ÅŸer. FotoÄŸraf ekle. Durum gÃ¼ncellenebilir.</div>
      </div>
    </div>

    <div class="userbox">
      <span class="chip">ğŸ‘¤ <span id="uName">KullanÄ±cÄ±: â€”</span></span>
      <span class="chip">ğŸ­ <span id="uRole">Rol: â€”</span></span>
      <button class="btn ghost" id="btnOpenMalzeme">â• Malzeme Talebi</button>
      <button class="btn danger" id="btnLogout">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: Yeni Tespit -->
    <div class="card">
      <div class="sectionTitle">ğŸ“Œ Yeni Tespit</div>

      <div class="row">
        <div>
          <label>Hedef Birim</label>
          <select id="hedefBirim">
            <option>GÃ¼venlik</option>
            <option>Teknik</option>
            <option>Temizlik</option>
            <option>Peyzaj</option>
            <option>Saha</option>
          </select>

          <div class="pillRow" aria-label="HÄ±zlÄ± birim seÃ§">
            <div class="pill active" data-birim="GÃ¼venlik">ğŸ›¡ï¸ GÃ¼venlik</div>
            <div class="pill" data-birim="Teknik">ğŸ§° Teknik</div>
            <div class="pill" data-birim="Temizlik">ğŸ§¼ Temizlik</div>
            <div class="pill" data-birim="Peyzaj">ğŸŒ¿ Peyzaj</div>
            <div class="pill" data-birim="Saha">ğŸ“ Saha</div>
          </div>
        </div>

        <div>
          <label>Tespit TÃ¼rÃ¼</label>
          <select id="tespitTuru">
            <option value="ariza">ArÄ±za / Teknik</option>
            <option value="temizlik">Temizlik / DÃ¼zen</option>
            <option value="guvenlik">GÃ¼venlik / Risk</option>
            <option value="peyzaj">Peyzaj / YeÅŸil Alan</option>
            <option value="diger">DiÄŸer</option>
          </select>

          <label>Ã–ncelik</label>
          <select id="oncelik">
            <option value="Normal">Normal</option>
            <option value="Acil">Acil</option>
            <option value="DÃ¼ÅŸÃ¼k">DÃ¼ÅŸÃ¼k</option>
          </select>
        </div>
      </div>

      <label>Konu / BaÅŸlÄ±k</label>
      <input id="konu" placeholder="Ã–rn: 550 Ada yÃ¼rÃ¼yÃ¼ÅŸ yolu lamba yanmÄ±yor" />

      <label>Konum / Alan</label>
      <input id="konum" placeholder="Ã–rn: 550 Ada - YÃ¼rÃ¼yÃ¼ÅŸ yolu - Blok A Ã¶nÃ¼" />

      <label>AÃ§Ä±klama</label>
      <textarea id="aciklama" placeholder="KÄ±sa ve net: Ne var? Nerede? Ne yapÄ±lmalÄ±?"></textarea>

      <label>Durum (Rol bazlÄ±)</label>
      <select id="durum">
        <option value="">â€”</option>
        <option value="YapÄ±ldÄ±">YapÄ±ldÄ±</option>
        <option value="Ertelendi">Ertelendi</option>
        <option value="Malzeme Bekleniyor">Malzeme Bekleniyor</option>
        <option value="ParÃ§a Bekleniyor">ParÃ§a Bekleniyor</option>
        <option value="Teklif Bekleniyor">Teklif Bekleniyor</option>
        <option value="DÄ±ÅŸ Servis Ã‡aÄŸrÄ±lacak">DÄ±ÅŸ Servis Ã‡aÄŸrÄ±lacak</option>
        <option value="DÄ±ÅŸ Servis Ã‡aÄŸrÄ±ldÄ±">DÄ±ÅŸ Servis Ã‡aÄŸrÄ±ldÄ±</option>
        <option value="DÄ±ÅŸ Servis Geldi / OnardÄ±">DÄ±ÅŸ Servis Geldi / OnardÄ±</option>
      </select>
      <div class="statusHint" id="durumHint">
        *GeliÅŸmiÅŸ seÃ§enekler: <b>Teknik Åef</b> + <b>Saha Sorumlusu/Amiri</b> iÃ§in aÃ§Ä±k.
      </div>

      <label>FotoÄŸraf(lar)</label>
      <input id="fotolar" type="file" accept="image/*" multiple />

      <div class="btnRow">
        <button class="btn" id="btnGonder">GÃ¶nder</button>
        <button class="btn secondary" id="btnTemizle">Temizle</button>
      </div>

      <div class="mini">Not: FotoÄŸraflar otomatik kÃ¼Ã§Ã¼ltÃ¼lerek gÃ¶nderilir (mobil iÃ§in hÄ±zlÄ±).</div>
    </div>

    <!-- RIGHT: Bilgi/Kontrol -->
    <div class="card">
      <div class="sectionTitle">ğŸ§¾ Bilgi / Kontrol</div>

      <label>GAS URL</label>
      <input id="gasUrl" readonly />

      <div class="kpi">
        <div class="box">
          <b>Oturum</b><br/>
          Bu giriÅŸ bir kez yapÄ±lÄ±r. Ã‡Ä±kÄ±ÅŸ yapmadÄ±kÃ§a sistem seni tanÄ±r.
        </div>
        <div class="box">
          <b>GÃ¶nderim</b><br/>
          JSON + Foto Base64
        </div>
        <div class="box">
          <b>Yetki</b><br/>
          Tespit: herkes<br/>
          Durum seÃ§enekleri: rol bazlÄ±
        </div>
        <div class="box">
          <b>Ä°pucu</b><br/>
          â€œFailed to fetchâ€ â†’ VPN / ÅŸebeke / izin engeli olabilir.
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted" style="font-size:12px">
        Bu sayfa GitHubâ€™da. KayÄ±t/Drive iÅŸlemleri Google Apps Scriptâ€™te.<br/>
        Talep ve durum akÄ±ÅŸÄ±nÄ± oturuma gÃ¶re yÃ¶netiyoruz.
      </div>

      <div class="hr"></div>

      <a class="smallLink" href="./panel.html">â† Panele dÃ¶n</a>
    </div>
  </div>
</div>

<!-- Drawer: Malzeme Talebi -->
<div class="drawerOverlay" id="drawerOverlay"></div>
<div class="drawer" id="drawer">
  <div class="drawerHeader">
    <strong>â• Malzeme Talebi</strong>
    <button class="btn ghost" id="btnCloseDrawer">Kapat âœ–</button>
  </div>

  <div class="drawerBody">
    <div class="muted" style="font-size:12px;margin-bottom:8px">
      Bu bÃ¶lÃ¼m: Teknik/Temizlik ÅŸefi (ve izin durumunda Saha Amirleri) iÃ§in.  
      Talep oluÅŸtur â†’ satÄ±n alma/muhasebe gÃ¶rsÃ¼n â†’ sÃ¼reÃ§ takip edilsin.
    </div>

    <label>Talep Eden Birim</label>
    <select id="mtBirim">
      <option>Teknik</option>
      <option>Temizlik</option>
      <option>Peyzaj</option>
      <option>GÃ¼venlik</option>
      <option>Saha</option>
    </select>

    <label>Talep BaÅŸlÄ±ÄŸÄ±</label>
    <input id="mtBaslik" placeholder="Ã–rn: Temizlik kimyasalÄ± / Ampul / Pompa parÃ§asÄ±" />

    <div class="row">
      <div>
        <label>Miktar</label>
        <input id="mtMiktar" placeholder="Ã–rn: 2" />
      </div>
      <div>
        <label>Birim</label>
        <select id="mtBirimTur">
          <option>Adet</option>
          <option>Kutu</option>
          <option>Kg</option>
          <option>Litre</option>
          <option>Metre</option>
          <option>Set</option>
        </select>
      </div>
    </div>

    <label>Aciliyet</label>
    <select id="mtAciliyet">
      <option value="Normal">Normal</option>
      <option value="Acil">Acil</option>
      <option value="Ã‡ok Acil">Ã‡ok Acil</option>
    </select>

    <label>Teslim / KullanÄ±m Yeri</label>
    <input id="mtYer" placeholder="Ã–rn: 553 Ada - Blok B / Depo / Sosyal tesis" />

    <label>AÃ§Ä±klama (Åartname / Detay)</label>
    <textarea id="mtAciklama" placeholder="Marka/Model, Ã¶lÃ§Ã¼, istenen Ã¶zellik, gerekÃ§e vb."></textarea>

    <label>FotoÄŸraf / Belge (opsiyonel)</label>
    <input id="mtFoto" type="file" accept="image/*" />

    <div class="hr"></div>

    <div class="muted" style="font-size:12px">
      Not: Bu talep Apps Scriptâ€™e <b>MALZEME_TALEP</b> aksiyonu ile gider.  
      Muhasebe/satÄ±n alma paneli sonra eklenebilir.
    </div>
  </div>

  <div class="drawerFooter">
    <button class="btn secondary" id="btnMtTemizle">Temizle</button>
    <button class="btn" id="btnMtGonder">Talebi GÃ¶nder</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  /*********
   *  AYAR: GAS URL
   *********/
  const GAS_URL = "https://script.google.com/macros/s/AKfycby0A6mQvJEK9VadLhAhUoiIk2xmDTsVIYT7zbulE7ZKXe24fwnA1bohLuKebV6c1ixulw/exec";

  /*********
   *  OTURUM (localStorage)
   *  login.html / panel.html ile uyumlu olacak ÅŸekilde esnek okuyoruz
   *********/
  function getSession(){
    const name =
      localStorage.getItem("personel") ||
      localStorage.getItem("userName") ||
      localStorage.getItem("adSoyad") ||
      localStorage.getItem("kullanici") ||
      "";
    const role =
      localStorage.getItem("rol") ||
      localStorage.getItem("role") ||
      localStorage.getItem("userRole") ||
      "";
    return { name, role };
  }

  function isPrivileged(role){
    const r = (role||"").toLowerCase();
    return (
      r.includes("teknik ÅŸef") ||
      r.includes("teknik sef") ||
      r.includes("saha amir") ||
      r.includes("saha soruml") ||
      r.includes("amir") ||
      r.includes("ÅŸef") ||
      r.includes("sef")
    );
  }

  /*********
   *  UI yardÄ±mcÄ±larÄ±
   *********/
  const toastEl = document.getElementById("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>toastEl.classList.remove("show"), 2600);
  }

  function setActivePill(birim){
    document.querySelectorAll(".pill").forEach(p=>{
      p.classList.toggle("active", p.dataset.birim === birim);
    });
  }

  /*********
   *  FOTO: kÃ¼Ã§Ã¼lt + base64
   *********/
  function fileToBase64Resized(file, maxW=1400, quality=0.82){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onerror = reject;
      reader.onload = () => {
        const img = new Image();
        img.onerror = reject;
        img.onload = () => {
          const ratio = Math.min(1, maxW / img.width);
          const w = Math.round(img.width * ratio);
          const h = Math.round(img.height * ratio);
          const c = document.createElement("canvas");
          c.width = w; c.height = h;
          const ctx = c.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const dataUrl = c.toDataURL("image/jpeg", quality);
          resolve({
            name: file.name,
            mimeType: "image/jpeg",
            base64: dataUrl.split(",")[1]
          });
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }

  async function filesToPayload(files, limit=10){
    const arr = Array.from(files || []).slice(0, limit);
    const out = [];
    for (const f of arr){
      out.push(await fileToBase64Resized(f));
    }
    return out;
  }

  /*********
   *  POST helper
   *********/
  async function postJSON(payload){
    const res = await fetch(GAS_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    // GAS bazen text dÃ¶ner; yine de yakalayalÄ±m:
    const txt = await res.text();
    try { return JSON.parse(txt); } catch(e){ return { ok: res.ok, raw: txt }; }
  }

  /*********
   *  SAYFA INIT
   *********/
  (function init(){
    document.getElementById("gasUrl").value = GAS_URL;

    const s = getSession();
    document.getElementById("uName").textContent = "KullanÄ±cÄ±: " + (s.name || "Bilinmiyor");
    document.getElementById("uRole").textContent = "Rol: " + (s.role || "Bilinmiyor");

    // Durum seÃ§enekleri: yetkisiz kiÅŸide geliÅŸmiÅŸleri gizle
    const durumSel = document.getElementById("durum");
    const privileged = isPrivileged(s.role);

    const advancedValues = new Set([
      "Malzeme Bekleniyor",
      "ParÃ§a Bekleniyor",
      "Teklif Bekleniyor",
      "DÄ±ÅŸ Servis Ã‡aÄŸrÄ±lacak",
      "DÄ±ÅŸ Servis Ã‡aÄŸrÄ±ldÄ±",
      "DÄ±ÅŸ Servis Geldi / OnardÄ±"
    ]);

    Array.from(durumSel.options).forEach(opt=>{
      if (advancedValues.has(opt.value)) opt.hidden = !privileged;
    });

    document.getElementById("durumHint").style.display = privileged ? "none" : "block";

    // Pill click
    document.querySelectorAll(".pill").forEach(p=>{
      p.addEventListener("click", ()=>{
        const b = p.dataset.birim;
        document.getElementById("hedefBirim").value = b;
        setActivePill(b);
      });
    });

    document.getElementById("hedefBirim").addEventListener("change", (e)=>{
      setActivePill(e.target.value);
    });
    setActivePill(document.getElementById("hedefBirim").value);

    // Malzeme butonu yetki kontrolÃ¼: butonu herkes gÃ¶rsÃ¼n ama iÃ§eriÄŸi yetkiye baÄŸlayabilirsin
    // Åimdilik: herkes aÃ§abilir; istersen burada kÄ±sÄ±tlarÄ±z.
    // Drawer
    const overlay = document.getElementById("drawerOverlay");
    const drawer = document.getElementById("drawer");
    const openDrawer = ()=>{
      overlay.classList.add("show");
      drawer.classList.add("show");
    };
    const closeDrawer = ()=>{
      overlay.classList.remove("show");
      drawer.classList.remove("show");
    };
    document.getElementById("btnOpenMalzeme").addEventListener("click", openDrawer);
    document.getElementById("btnCloseDrawer").addEventListener("click", closeDrawer);
    overlay.addEventListener("click", closeDrawer);

    // Logout
    document.getElementById("btnLogout").addEventListener("click", ()=>{
      // oturum anahtarlarÄ±nÄ± temizle
      ["personel","userName","adSoyad","kullanici","rol","role","userRole"].forEach(k=>localStorage.removeItem(k));
      toast("Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.");
      setTimeout(()=>{ window.location.href="./login.html"; }, 500);
    });

    // Temizle
    document.getElementById("btnTemizle").addEventListener("click", ()=>{
      ["konu","konum","aciklama"].forEach(id=>document.getElementById(id).value="");
      document.getElementById("durum").value="";
      document.getElementById("fotolar").value="";
      toast("Temizlendi.");
    });

    // GÃ¶nder (Tespit)
    document.getElementById("btnGonder").addEventListener("click", async ()=>{
      const ses = getSession();
      const birim = document.getElementById("hedefBirim").value;
      const tur = document.getElementById("tespitTuru").value;
      const oncelik = document.getElementById("oncelik").value;
      const konu = document.getElementById("konu").value.trim();
      const konum = document.getElementById("konum").value.trim();
      const aciklama = document.getElementById("aciklama").value.trim();
      const durum = document.getElementById("durum").value;

      if (!birim || !aciklama){
        toast("Birim ve aÃ§Ä±klama zorunlu.");
        return;
      }

      const files = document.getElementById("fotolar").files;
      let fotolar = [];
      try{
        if (files && files.length) fotolar = await filesToPayload(files, 10);
      }catch(err){
        toast("FotoÄŸraf okunamadÄ±.");
        return;
      }

      const payload = {
        action: "TESPIT",
        birim,
        tespitTuru: tur,
        oncelik,
        konu,
        konum,
        aciklama,
        durum,
        personel: ses.name || "Bilinmiyor",
        rol: ses.role || "Bilinmiyor",
        tarih: new Date().toISOString(),
        fotograflar: fotolar
      };

      try{
        toast("GÃ¶nderiliyor...");
        const out = await postJSON(payload);
        if (out && out.ok){
          toast("âœ… Tespit gÃ¶nderildi.");
          document.getElementById("btnTemizle").click();
        }else{
          toast("âš ï¸ GÃ¶nderim baÅŸarÄ±sÄ±z: " + (out.error || out.raw || "Bilinmiyor"));
        }
      }catch(e){
        toast("âŒ Failed to fetch (VPN/ÅŸebeke/izin).");
      }
    });

    // Malzeme temizle
    document.getElementById("btnMtTemizle").addEventListener("click", ()=>{
      ["mtBaslik","mtMiktar","mtYer","mtAciklama"].forEach(id=>document.getElementById(id).value="");
      document.getElementById("mtBirimTur").value="Adet";
      document.getElementById("mtAciliyet").value="Normal";
      document.getElementById("mtFoto").value="";
      toast("Talep formu temizlendi.");
    });

    // Malzeme gÃ¶nder
    document.getElementById("btnMtGonder").addEventListener("click", asyn

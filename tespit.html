<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tespit Bildirim EkranÄ±</title>
  <style>
    :root{
      --bg:#f3f5f7; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --blue:#2563eb; --blue2:#1d4ed8;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:38px;height:38px;border-radius:12px;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
    .title h1{margin:0;font-size:20px}
    .title p{margin:2px 0 0;color:var(--muted);font-size:13px}
    .session{display:flex;align-items:center;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;font-size:12px;color:var(--muted)}
    .chip strong{color:var(--text)}
    .btn{border:0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-blue:hover{background:var(--blue2)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{margin:0 0 6px;font-size:16px}
    .card p.sub{margin:0 0 12px;color:var(--muted);font-size:12px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;
      font-size:14px;background:#fff;outline:none
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 520px){.row{grid-template-columns:1fr}}
    .hint{margin-top:10px;color:var(--muted);font-size:12px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-size:13px}
    .msg.ok{border-color:#bbf7d0;background:#f0fdf4;color:#14532d}
    .msg.bad{border-color:#fecaca;background:#fff1f2;color:#7f1d1d}
    .msg.warn{border-color:#fde68a;background:#fffbeb;color:#7c2d12}
    .mini{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{border:1px dashed var(--line);background:#fff;border-radius:999px;padding:7px 10px;font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">S</div>
        <div class="title">
          <h1>Tespit Bildirim EkranÄ±</h1>
          <p>Herkes tespit girebilir. Teknik/Temizlik iÅŸleri iÃ§in durum gÃ¼ncellenebilir (geliÅŸmiÅŸ seÃ§enekler: Teknik Åef + Saha Amir).</p>
        </div>
      </div>

      <div class="session">
        <div class="chip" title="GiriÅŸ bilgisi localStorage Ã¼zerinden okunur.">
          ğŸ‘¤ <strong id="uName">Bilinmiyor</strong> <span class="muted" id="uRole">(Rol?)</span>
        </div>
        <button class="btn btn-blue" id="btnReset">Ã‡Ä±kÄ±ÅŸ / SÄ±fÄ±rla</button>
      </div>
    </div>

    <div class="grid">
      <!-- Sol: Yeni tespit -->
      <div class="card">
        <h2>ğŸ“Œ Yeni Tespit OluÅŸtur</h2>
        <p class="sub">Hedef birimi seÃ§, kÄ±sa aÃ§Ä±klama + yer + fotoÄŸraf ekle. (FotoÄŸraf opsiyonel)</p>

        <div class="row">
          <div>
            <label>Hedef Birim</label>
            <select id="hedefBirim" required>
              <option value="Teknik">Teknik</option>
              <option value="Temizlik">Temizlik</option>
              <option value="GÃ¼venlik">GÃ¼venlik</option>
              <option value="Peyzaj">Peyzaj</option>
              <option value="Saha Sorumlusu">Saha Sorumlusu</option>
              <option value="YÃ¶netim">YÃ¶netim</option>
            </select>
          </div>
          <div>
            <label>Ã–ncelik</label>
            <select id="oncelik">
              <option value="Normal">Normal</option>
              <option value="Acil">Acil</option>
              <option value="Kritik">Kritik</option>
            </select>
          </div>
        </div>

        <label>Konu / BaÅŸlÄ±k</label>
        <input id="konu" placeholder="Ã–rn: 550 Ada yÃ¼rÃ¼yÃ¼ÅŸ yolu lamba yanmÄ±yor" />

        <label>Konum / Alan</label>
        <input id="konum" placeholder="Ã–rn: 550 Ada - YÃ¼rÃ¼yÃ¼ÅŸ yolu - Blok A Ã¶nÃ¼" />

        <label>AÃ§Ä±klama</label>
        <textarea id="aciklama" placeholder="KÄ±sa ve net yaz: Ne gÃ¶rdÃ¼n? Ne gerekiyor?"></textarea>

        <label>FotoÄŸraf(lar) (opsiyonel) â€” en fazla 3 adet</label>
        <input id="fotoYeni" type="file" accept="image/*" multiple />

        <div class="mini">
          <span class="pill">âœ… GÃ¶nderince: Sistem ID Ã¼retir (TSP-...)</span>
          <span class="pill">ğŸ“ Driveâ€™a: YÄ±l > DÃ¶nem > Birim > Personel</span>
        </div>

        <div class="hr"></div>

        <button class="btn btn-blue" id="btnYeni">GÃ¶nder</button>
        <div id="msgYeni"></div>
      </div>

      <!-- SaÄŸ: Durum gÃ¼ncelle / sonuÃ§ ekle -->
      <div class="card">
        <h2>âœ… Durum GÃ¼ncelle / SonuÃ§ Ekle</h2>
        <p class="sub">
          Teknik/Temizlik iÅŸlerinde â€œYapÄ±ldÄ± / Ertelendi / ParÃ§a bekleniyor / DÄ±ÅŸ servisâ€¦â€ gibi durum eklenir.
          <br><b>GeliÅŸmiÅŸ seÃ§enekler</b> sadece <b>Teknik Åef</b> ve <b>Saha Amir</b> iÃ§in aÃ§Ä±lÄ±r.
        </p>

        <label>Tespit ID (varsa)</label>
        <input id="tespitId" placeholder="Ã–rn: TSP-20260209-001 (yoksa boÅŸ bÄ±rakabilirsin)" />

        <label>Ä°lgili Birim</label>
        <select id="ilgiliBirim">
          <option value="Teknik">Teknik</option>
          <option value="Temizlik">Temizlik</option>
          <option value="GÃ¼venlik">GÃ¼venlik</option>
          <option value="Peyzaj">Peyzaj</option>
          <option value="Saha Sorumlusu">Saha Sorumlusu</option>
          <option value="YÃ¶netim">YÃ¶netim</option>
        </select>

        <label>Durum</label>
        <select id="durumSelect"></select>

        <label>Not / AÃ§Ä±klama</label>
        <textarea id="durumNot" placeholder="Ã–rn: Lamba deÄŸiÅŸti, foto eklendi / YarÄ±n 10:00 planlandÄ±"></textarea>

        <label>FotoÄŸraf (opsiyonel) â€” 1 adet</label>
        <input id="fotoDurum" type="file" accept="image/*" />

        <div class="mini">
          <span class="pill">ğŸ•” 17:00 yapÄ±lmayanlar (mail)</span>
          <span class="pill">ğŸŒ™ 00:00 gÃ¼nlÃ¼k rapor (mail)</span>
          <span class="pill">â± 24 saat SLA uyarÄ±</span>
        </div>

        <div class="hr"></div>

        <button class="btn btn-blue" id="btnDurum">Durumu Kaydet</button>
        <div id="msgDurum"></div>
        <div class="hint">
          Not: Mail/rapor/SLA tarafÄ± Apps Script tetikleyicilerle Ã§alÄ±ÅŸÄ±r. Bu sayfa sadece veri gÃ¶nderir.
        </div>
      </div>
    </div>
  </div>

<script>
/** ============================
 *  AYARLAR
 *  ============================ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby0A6mQvJEK9VadLhAhUoiIk2xmDTsVIYT7zbulE7ZKXe24fwnA1bohLuKebV6c1ixulw/exec";

/** ============================
 *  OTURUM OKUMA (localStorage)
 *  login.html tarafÄ±ndaki key'ler farklÄ± olsa bile yakalamaya Ã§alÄ±ÅŸÄ±r.
 *  ============================ */
function getSession(){
  const ls = window.localStorage;

  // olasÄ± anahtarlar
  const name =
    ls.getItem("personel") ||
    ls.getItem("personelAd") ||
    ls.getItem("personelName") ||
    ls.getItem("adSoyad") ||
    ls.getItem("name") ||
    ls.getItem("user") ||
    "";

  const role =
    ls.getItem("rol") ||
    ls.getItem("role") ||
    ls.getItem("unvan") ||
    ls.getItem("gorev") ||
    "";

  const birim =
    ls.getItem("birim") ||
    ls.getItem("unit") ||
    "";

  return {
    personel: (name || "").trim(),
    rol: (role || "").trim(),
    birim: (birim || "").trim()
  };
}

function isPrivileged(rol){
  // Teknik ÅŸef + saha amirleri (yÄ±llÄ±k izin / vekalet iÃ§in)
  const r = (rol || "").toLowerCase();
  return r.includes("teknik ÅŸef") || r.includes("teknik sef") || r.includes("saha amir") || r.includes("saha sorumlu");
}

/** ============================
 *  DURUM SEÃ‡ENEKLERÄ°
 *  ============================ */
const STATUS_BASIC = [
  "YapÄ±ldÄ±",
  "Ertelendi",
  "YarÄ±n / PlanlandÄ±",
  "Malzeme yok",
  "Personel yok",
  "Zaman yetmedi"
];

const STATUS_ADVANCED = [
  "ParÃ§a bekleniyor",
  "Malzeme bekleniyor",
  "Teklif bekleniyor",
  "DÄ±ÅŸ servis Ã§aÄŸrÄ±lacak",
  "DÄ±ÅŸ servis Ã§aÄŸrÄ±ldÄ±",
  "DÄ±ÅŸ servis geldi / onardÄ±"
];

/** ============================
 *  UI yardÄ±mcÄ±larÄ±
 *  ============================ */
function setMsg(el, type, text){
  el.innerHTML = "";
  const box = document.createElement("div");
  box.className = "msg " + type;
  box.textContent = text;
  el.appendChild(box);
}

function clearMsg(el){ el.innerHTML = ""; }

function pad2(n){ return String(n).padStart(2,"0"); }
function nowIso(){
  const d = new Date();
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate())+" "+pad2(d.getHours())+":"+pad2(d.getMinutes());
}

/** ============================
 *  Foto -> base64
 *  ============================ */
function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function filesToPayload(files, maxCount){
  const out = [];
  const arr = Array.from(files || []).slice(0, maxCount);
  for (const f of arr){
    const dataUrl = await fileToBase64(f);
    out.push({
      name: f.name,
      type: f.type,
      size: f.size,
      base64: dataUrl.split(",")[1] // sadece base64 kÄ±smÄ±
    });
  }
  return out;
}

/** ============================
 *  API POST
 *  ============================ */
async function postJSON(payload){
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(payload)
  });
  // Apps Script bazen 200 dÃ¶nse bile text dÃ¶ner:
  const txt = await res.text();
  let data;
  try { data = JSON.parse(txt); }
  catch { data = { ok:false, error:"JSON parse edilemedi", raw:txt }; }
  return data;
}

/** ============================
 *  BaÅŸlangÄ±Ã§
 *  ============================ */
const sess = getSession();
document.getElementById("uName").textContent = sess.personel || "Bilinmiyor";
document.getElementById("uRole").textContent = sess.rol ? (${sess.rol}) : "(Rol?)";

const durSel = document.getElementById("durumSelect");
function fillStatus(){
  durSel.innerHTML = "";
  const list = [...STATUS_BASIC];
  if (isPrivileged(sess.rol)) list.push(...STATUS_ADVANCED);

  for (const s of list){
    const opt = document.createElement("option");
    opt.value = s; opt.textContent = s;
    durSel.appendChild(opt);
  }
}
fillStatus();

/** ============================
 *  SÄ±fÄ±rla / Ã§Ä±kÄ±ÅŸ
 *  ============================ */
document.getElementById("btnReset").addEventListener("click", ()=>{
  // sadece tespit ekranÄ± iÃ§in en gÃ¼venlisi: localStorage temizleme yerine ilgili anahtarlarÄ± silmeye Ã§alÄ±ÅŸ
  const keys = ["personel","personelAd","personelName","adSoyad","name","user","rol","role","unvan","gorev","birim","unit"];
  keys.forEach(k=> localStorage.removeItem(k));
  alert("Oturum bilgisi sÄ±fÄ±rlandÄ±. GiriÅŸ sayfasÄ±ndan tekrar giriÅŸ yapabilirsin.");
  location.reload();
});

/** ============================
 *  Yeni Tespit GÃ¶nder
 *  ============================ */
document.getElementById("btnYeni").addEventListener("click", async ()=>{
  const msgEl = document.getElementById("msgYeni");
  clearMsg(msgEl);

  const hedefBirim = document.getElementById("hedefBirim").value;
  const oncelik = document.getElementById("oncelik").value;
  const konu = document.getElementById("konu").value.trim();
  const konum = document.getElementById("konum").value.trim();
  const aciklama = document.getElementById("aciklama").value.trim();
  const files = document.getElementById("fotoYeni").files;

  if (!sess.personel){
    setMsg(msgEl, "warn", "Oturum bilgisi bulunamadÄ±. LÃ¼tfen giriÅŸ (login) sayfasÄ±ndan tekrar giriÅŸ yap.");
    return;
  }
  if (!hedefBirim || !konu || !aciklama){
    setMsg(msgEl, "bad", "Eksik alan var: Hedef Birim + Konu + AÃ§Ä±klama zorunlu.");
    return;
  }

  try{
    setMsg(msgEl, "warn", "GÃ¶nderiliyorâ€¦");
    const fotolar = await filesToPayload(files, 3);

    const payload = {
      type: "TESPIT_CREATE",
      tarih: nowIso(),
      personel: sess.personel,
      rol: sess.rol || "",
      birim: sess.birim || "",
      hedefBirim,
      oncelik,
      konu,
      konum,
      aciklama,
      fotograflar: fotolar
    };

    const data = await postJSON(payload);
    if (data && data.ok){
      setMsg(msgEl, "ok", âœ… Tespit gÃ¶nderildi. ${data.tespitId ? ("ID: "+data.tespitId) : ""});
      // temizle
      document.getElementById("konu").value = "";
      document.getElementById("konum").value = "";
      document.getElementById("aciklama").value = "";
      document.getElementById("fotoYeni").value = "";
    }else{
      setMsg(msgEl, "bad", âŒ Hata: ${data.error || "Bilinmeyen hata"});
      console.log("Hata detayÄ±:", data);
    }
  }catch(err){
    setMsg(msgEl, "bad", "âŒ GÃ¶nderim sÄ±rasÄ±nda hata oluÅŸtu (internet / eriÅŸim / CORS).");
    console.error(err);
  }
});

/** ============================
 *  Durum GÃ¼ncelle
 *  ============================ */
document.getElementById("btnDurum").addEventListener("click", async ()=>{
  const msgEl = document.getElementById("msgDurum");
  clearMsg(msgEl);

  const tespitId = document.getElementById("tespitId").value.trim();
  const ilgiliBirim = document.getElementById("ilgiliBirim").value;
  const durum = document.getElementById("durumSelect").value;
  const not = document.getElementById("durumNot").value.trim();
  const f = document.getElementById("fotoDurum").files?.[0] || null;

  if (!sess.personel){
    setMsg(msgEl, "warn", "Oturum bilgisi bulunamadÄ±. LÃ¼tfen giriÅŸ (login) sayfasÄ±ndan tekrar giriÅŸ yap.");
    return;
  }
  if (!ilgiliBirim || !durum || !not){
    setMsg(msgEl, "bad", "Eksik alan var: Ä°lgili Birim + Durum + Not zorunlu.");
    return;
  }

  // geliÅŸmiÅŸ seÃ§eneÄŸi yetkisiz kiÅŸi seÃ§emesin
  if (STATUS_ADVANCED.includes(durum) && !isPrivileged(sess.rol)){
    setMsg(msgEl, "bad", "Bu durum seÃ§eneÄŸi sadece Teknik Åef / Saha Amir iÃ§in aÃ§Ä±ktÄ±r.");
    return;
  }

  try{
    setMsg(msgEl, "warn", "Kaydediliyorâ€¦");
    const fotoArr = f ? await filesToPayload([f], 1) : [];

    const payload = {
      type: "TESPIT_UPDATE",
      tarih: nowIso(),
      personel: sess.personel,
      rol: sess.rol || "",
      birim: sess.birim || "",
      tespitId: tespitId || "",
      ilgiliBirim,
      durum,
      not,
      fotograflar: fotoArr
    };

    const data = await postJSON(payload);
    if (data && data.ok){
      setMsg(msgEl, "ok", âœ… Durum kaydedildi. ${data.tespitId ? ("ID: "+data.tespitId) : ""});
      document.getElementById("durumNot").value = "";
      document.getElementById("fotoDurum").value = "";
    }else{
      setMsg(msgEl, "bad", âŒ Hata: ${data.error || "Bilinmeyen hata"});
      console.log("Hata detayÄ±:", data);
    }
  }catch(err){
    setMsg(msgEl, "bad", "âŒ Kaydetme sÄ±rasÄ±nda hata oluÅŸtu (internet / eriÅŸim / CORS).");
    console.error(err);
  }
});
</script>
</body>
</html>

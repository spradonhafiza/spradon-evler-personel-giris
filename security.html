<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GÃ¼venlik Bildirimi</title>
  <style>
    body{background:#2f3e3e;font-family:Arial;color:#fff;margin:0;padding:18px}
    .wrap{max-width:520px;margin:0 auto}
    .card{background:#4a5a5a;border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:0;margin-top:10px}
    button{cursor:pointer;font-weight:bold}
    .btn{background:#c9d26a;color:#111}
    .btn2{background:#7aa0ff;color:#111}
    .muted{opacity:.85;font-size:12px}
    .item{background:#3c4a4a;border-radius:10px;padding:10px;margin-top:10px}
    img{width:100%;border-radius:10px;margin-top:8px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .link{color:#c9d26a;cursor:pointer;text-decoration:underline}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div><b>GÃ¼venlik Bildirimi</b> ğŸ“¸</div>
    <div class="link" onclick="goBack()">â† Panele DÃ¶n</div>
  </div>

  <div class="card">
    <div class="muted">Ä°nternet olmasa da kayÄ±t cihazda saklanÄ±r. Ä°nternet gelince â€œBekleyenlerâ€ bÃ¶lÃ¼mÃ¼nden dÄ±ÅŸa aktar / (sonraki adÄ±mda) otomatik gÃ¶nder.</div>

    <input id="photo" type="file" accept="image/*" capture="environment" />
    <select id="cat">
      <option value="">Kategori seÃ§</option>
      <option>KapÄ±sÄ± aÃ§Ä±k daire</option>
      <option>AraÃ§ farÄ± aÃ§Ä±k</option>
      <option>AraÃ§ camÄ± aÃ§Ä±k</option>
      <option>AydÄ±nlatma yanmÄ±yor</option>
      <option>Buluntu eÅŸya</option>
      <option>DiÄŸer</option>
    </select>
    <textarea id="note" rows="2" placeholder="KÄ±sa not (opsiyonel)"></textarea>

    <button class="btn" onclick="save()">Kaydet (Bekleyenlere ekle)</button>
    <button class="btn2" onclick="exportJson()">Bekleyenleri DÄ±ÅŸa Aktar (JSON)</button>

    <div class="muted" style="margin-top:10px">
      Durum: <b id="net"></b> â€” Bekleyen kayÄ±t: <b id="count"></b>
    </div>

    <div id="list"></div>
  </div>
</div>

<script>
  const LS_QUEUE = "spradon_security_queue";
  const LS_CURRENT = "spradon_current_user";

  function currentUser(){
    const raw = localStorage.getItem(LS_CURRENT);
    return raw ? JSON.parse(raw) : null;
  }

  function loadQueue(){
    const raw = localStorage.getItem(LS_QUEUE);
    return raw ? JSON.parse(raw) : [];
  }
  function saveQueue(q){
    localStorage.setItem(LS_QUEUE, JSON.stringify(q));
  }

  function updateNet(){
    document.getElementById("net").textContent = navigator.onLine ? "Ä°nternet var âœ…" : "Ä°nternet yok â›”";
  }

  function render(){
    updateNet();
    const q = loadQueue();
    document.getElementById("count").textContent = q.length;

    let html = "";
    q.slice().reverse().forEach((x, idxRev) => {
      const idx = q.length - 1 - idxRev;
      html += `
        <div class="item">
          <div><b>${x.cat || "Kategori yok"}</b> â€” <span class="muted">${x.when}</span></div>
          <div class="muted">Bildiren: ${x.byName} (${x.byDept})</div>
          ${x.note ? <div style="margin-top:6px">${x.note}</div> : ``}
          ${x.dataUrl ? <img src="${x.dataUrl}" /> : ``}
          <div class="muted" style="margin-top:6px">Durum: ${x.status}</div>
          <button style="margin-top:8px" onclick="removeOne(${idx})">Sil</button>
        </div>
      `;
    });
    document.getElementById("list").innerHTML = html || <div class="muted" style="margin-top:10px">Bekleyen kayÄ±t yok.</div>;
  }

  async function fileToDataUrl(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function save(){
    const u = currentUser();
    if(!u){
      alert("Oturum yok. GiriÅŸ yapmalÄ±sÄ±n.");
      location.href = "index.html";
      return;
    }

    const file = document.getElementById("photo").files[0];
    const cat = document.getElementById("cat").value;
    const note = document.getElementById("note").value.trim();

    if(!file || !cat){
      alert("FotoÄŸraf + kategori seÃ§melisin.");
      return;
    }

    const dataUrl = await fileToDataUrl(file);

    const q = loadQueue();
    q.push({
      cat,
      note,
      dataUrl,
      when: new Date().toLocaleString("tr-TR"),
      byId: u.id,
      byName: u.name,
      byDept: u.dept,
      status: navigator.onLine ? "Ä°nternet var: GÃ¶nderime hazÄ±r" : "Ä°nternet yok: Beklemede"
    });
    saveQueue(q);

    document.getElementById("photo").value = "";
    document.getElementById("cat").value = "";
    document.getElementById("note").value = "";

    alert("Kaydedildi âœ…");
    render();
  }

  function removeOne(i){
    const q = loadQueue();
    q.splice(i, 1);
    saveQueue(q);
    render();
  }

  function exportJson(){
    const q = loadQueue();
    if(q.length === 0){
      alert("Bekleyen kayÄ±t yok.");
      return;
    }
    const blob = new Blob([JSON.stringify(q, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "guvenlik_bekleyen_kayitlar.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Ä°nternet gelince bekleyenlerin durumunu gÃ¼ncelle (demo)
  window.addEventListener("online", () => {
    const q = loadQueue().map(x => ({...x, status:"Ä°nternet var: GÃ¶nderime hazÄ±r"}));
    saveQueue(q);
    render();
  });
  window.addEventListener("offline", render);

  function goBack(){ location.href = "panel.html"; }

  render();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GÃ¼venlik FotoÄŸraf YÃ¼kleme</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f4f4;padding:20px}
    .kutu{background:#fff;border-radius:12px;max-width:520px;margin:0 auto;padding:18px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    h2{margin:0 0 12px}
    label{display:block;margin-top:10px;font-weight:700}
    input,select,button{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid #ddd;box-sizing:border-box}
    button{border:none;cursor:pointer;font-weight:800}
    .btn{background:#2563eb;color:#fff;margin-top:14px}
    .durum{margin-top:14px;padding:12px;border-radius:10px;background:#f8fafc;border:1px dashed #cbd5e1;min-height:24px}
    .mini{font-size:12px;color:#64748b;margin-top:10px}
  </style>
</head>
<body>
  <div class="kutu">
    <h2>ğŸ›¡ï¸ GÃ¼venlik Bildirimi (FotoÄŸraf)</h2>

    <label>Personel</label>
    <input id="personel" placeholder="Ã–rn: AkÄ±n" value="AkÄ±n" />

    <label>Personel ID</label>
    <input id="personelId" placeholder="Ã–rn: A101" value="A101" />

    <label>Birim</label>
    <select id="birim">
      <option>GÃ¼venlik</option>
      <option>Teknik</option>
      <option>Temizlik</option>
      <option>YÃ¶netim</option>
    </select>

    <label>Tarih</label>
    <input id="tarih" />

    <label>FotoÄŸraflar</label>
    <input id="foto" type="file" accept="image/*" multiple />

    <button class="btn" id="gonder">ğŸ“¤ FotoÄŸraflarÄ± GÃ¶nder</button>

    <div class="durum" id="durum">HazÄ±r.</div>
    <div class="mini">Backend: Google Apps Script Web App (/exec)</div>
  </div>

  <script>
    /* === GAS BACKEND (SENÄ°N LÄ°NKÄ°N) === */
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxnORQbPdpPw9KuvskTWeT1LtucQPoeOqg6pn78BIYoHu8LBD8TpGCa8A0AuAhjqwPnxg/exec";

    // Tarih input default
    const tarihEl = document.getElementById("tarih");
    const bugÃ¼n = new Date();
    const yyyy = bugÃ¼n.getFullYear();
    const mm = String(bugÃ¼n.getMonth()+1).padStart(2,"0");
    const dd = String(bugÃ¼n.getDate()).padStart(2,"0");
    tarihEl.value = ${yyyy}-${mm}-${dd};

    const durum = document.getElementById("durum");
    const btn = document.getElementById("gonder");

    function setDurum(msg){ durum.textContent = msg; }

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> {
          const dataUrl = String(r.result || "");
          // "data:image/jpeg;base64,XXXX" -> sadece XXXX
          const base64 = dataUrl.split(",")[1] || "";
          resolve({
            name: file.name || ("foto_"+Date.now()+".jpg"),
            mimeType: file.type || "image/jpeg",
            base64
          });
        };
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    btn.addEventListener("click", async ()=>{
      try{
        btn.disabled = true;

        const personel = document.getElementById("personel").value.trim();
        const personelId = document.getElementById("personelId").value.trim();
        const birim = document.getElementById("birim").value.trim();
        const tarih = document.getElementById("tarih").value.trim();

        const files = Array.from(document.getElementById("foto").files || []);
        if(!personel || !personelId || !birim){
          setDurum("âŒ LÃ¼tfen Personel / Personel ID / Birim doldur.");
          btn.disabled = false;
          return;
        }
        if(files.length === 0){
          setDurum("âŒ En az 1 fotoÄŸraf seÃ§.");
          btn.disabled = false;
          return;
        }

        setDurum("â³ FotoÄŸraflar hazÄ±rlanÄ±yor...");
        const resimler = [];
        for(const f of files){
          resimler.push(await fileToBase64(f));
        }

        // GAS tarafÄ± bu alan adlarÄ±nÄ± kabul ediyor: birim/personel/miktar... + fotoBase64/fotoAdi/mimeType
        // Biz Ã§oklu foto iÃ§in items array gÃ¶nderiyoruz:
        const items = resimler.map((img, i)=>({
          birim,
          alan: "GÃ¼venlik Bildirimi",
          urun: FotoÄŸraf ${i+1},   // zorunlu alanlara takÄ±lmamak iÃ§in
          miktar: 1,
          aciklama: ${personel} (${personelId}) - ${tarih},
          fotoBase64: img.base64,
          fotoAdi: img.name,
          mimeType: img.mimeType
        }));

        const payload = { items };

        setDurum("ğŸ“¤ GÃ¶nderiliyor...");
        const r = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await r.json().catch(()=>null);

        if(out && out.ok){
          setDurum("âœ… GÃ¶nderildi. Sheet + Drive kontrol et.");
        }else{
          setDurum("âŒ Hata: " + ((out && (out.msg || out.error)) || "Bilinmeyen"));
        }
      }catch(e){
        setDurum("âŒ BaÄŸlantÄ± hatasÄ± / CORS: " + (e && e.message ? e.message : e));
      }finally{
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>

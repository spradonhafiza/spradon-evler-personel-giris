<!doctype html>
<html lang="tr" translate="no" class="notranslate">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="google" content="notranslate" />
  <meta http-equiv="content-language" content="tr" />
  <title>Spradon HafÄ±za â€¢ GÃ¼venlik</title>

  <style>
    :root{
      --bg:#0b1220; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.08);
      --text:#e8eefc; --muted:rgba(232,238,252,.7);
      --ok:#2ecc71; --warn:#f39c12; --bad:#e74c3c; --btn:#2563eb; --btn2:#0f1b33;
      --line:rgba(255,255,255,.12);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(37,99,235,.35), transparent 60%),
                  radial-gradient(1000px 700px at 110% 0%, rgba(46,204,113,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{ max-width:980px; margin:0 auto; }
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(37,99,235,.9), rgba(46,204,113,.7));
      display:grid; place-items:center; font-weight:800;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      user-select:none;
    }
    .title{
      line-height:1.1;
    }
    .title h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .title div{ margin-top:2px; font-size:12px; color:var(--muted); }
    .pill{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:6px 10px; border-radius:999px; font-size:12px;
    }
    .chip b{ font-weight:700; }
    .grid{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 12px 34px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 14px 10px;
      font-size:15px; letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--line);
    }
    .card .body{ padding:14px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:600px){ .row{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height:92px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(232,238,252,.35); }
    .actions{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:12px;
    }
    .btn{
      border:0; cursor:pointer; user-select:none;
      padding:12px 14px; border-radius:14px;
      font-weight:700; letter-spacing:.2px;
      background: var(--btn);
      color:white;
      box-shadow:0 12px 26px rgba(37,99,235,.25);
    }
    .btn.secondary{ background: rgba(255,255,255,.08); color:var(--text); border:1px solid var(--line); box-shadow:none; }
    .btn.danger{ background: rgba(231,76,60,.18); border:1px solid rgba(231,76,60,.35); box-shadow:none; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .status{
      margin-top:10px; padding:10px 12px;
      border-radius:14px; border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.12);
      font-size:13px; color:var(--muted);
      white-space:pre-wrap;
    }
    .ok{ color: var(--ok); }
    .warn{ color: var(--warn); }
    .bad{ color: var(--bad); }
    .mini{ font-size:12px; color:var(--muted); line-height:1.35; }
    .photos{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
      margin-top:10px;
    }
    @media (max-width: 560px){ .photos{ grid-template-columns:1fr; } }
    .thumb{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:190px; object-fit:cover; display:block; }
    .thumb .cap{ padding:8px 10px; font-size:12px; color:var(--muted); }
    .hr{ height:1px; background: var(--line); margin:12px 0; }
    .smallline{ height:1px; background: rgba(255,255,255,.08); margin:10px 0; }
    .rightStack{ display:flex; flex-direction:column; gap:14px; }
    .note{
      font-size:12px; color:var(--muted);
      border-left:3px solid rgba(46,204,113,.6);
      padding-left:10px;
    }
    .kpi{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    .kpi .box{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:10px 12px;
    }
    .kpi .box .v{ font-size:18px; font-weight:800; }
    .kpi .box .t{ font-size:12px; color:var(--muted); margin-top:2px; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="badge">S</div>
      <div class="title">
        <h1>Spradon HafÄ±za â€¢ GÃ¼venlik</h1>
        <div>Foto + not + offline kayÄ±t (internet gelince toplu gÃ¶nderim)</div>
      </div>
    </div>

    <div class="pill">
      <div class="chip">Durum: <b id="netTxt">â€”</b></div>
      <div class="chip">Offline kuyruk: <b id="qTxt">0</b></div>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT: MAIN FORM -->
    <div class="card">
      <h2>
        <span>ğŸ“¸ KayÄ±t OluÅŸtur</span>
        <span class="mini" id="clockTxt">â€”</span>
      </h2>
      <div class="body">

        <div class="row">
          <div>
            <label>Personel AdÄ±</label>
            <input id="personel" placeholder="Ã–rn: AkÄ±n" autocomplete="name" />
          </div>
          <div>
            <label>Personel ID / Sicil</label>
            <input id="personelId" placeholder="Ã–rn: A101" autocomplete="off" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>Birim</label>
            <select id="birim">
              <option value="GÃ¼venlik">GÃ¼venlik</option>
              <option value="Teknik">Teknik</option>
              <option value="Temizlik">Temizlik</option>
              <option value="YÃ¶netim">YÃ¶netim</option>
              <option value="DiÄŸer">DiÄŸer</option>
            </select>
          </div>
          <div>
            <label>Tarih</label>
            <input id="tarih" type="date" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Not / AÃ§Ä±klama</label>
          <textarea id="not" placeholder="Ã–rn: 550 ada giriÅŸ kapÄ±sÄ±â€¦"></textarea>
        </div>

        <div style="margin-top:10px;">
          <label>FotoÄŸraf(lar) (opsiyonel)</label>
          <input id="foto" type="file" accept="image/*" capture="environment" multiple />
          <div class="mini" style="margin-top:6px;">
            Not: FotoÄŸraflar otomatik kÃ¼Ã§Ã¼ltÃ¼lÃ¼r (hÄ±z + kota iÃ§in). Ã‡ok bÃ¼yÃ¼k/HEIC dosyalarda bazÄ± cihazlar desteklemeyebilir.
          </div>

          <div class="photos" id="photoPreview" style="display:none;"></div>
        </div>

        <div class="actions">
          <button class="btn" id="btnSend">âœ… Kaydet & GÃ¶nder</button>
          <button class="btn secondary" id="btnSaveOffline">ğŸ“¦ Sadece Offline Kaydet</button>
          <button class="btn secondary" id="btnClearForm">ğŸ§¹ Formu Temizle</button>
        </div>

        <div class="status" id="statusBox">HazÄ±r.</div>

      </div>
    </div>

    <!-- RIGHT: SETTINGS + OFFLINE -->
    <div class="rightStack">

      <div class="card">
        <h2>ğŸ§  Offline & GÃ¶nderim</h2>
        <div class="body">

          <div class="kpi">
            <div class="box">
              <div class="v" id="kpiQueue">0</div>
              <div class="t">Cihazda bekleyen kayÄ±t</div>
            </div>
            <div class="box">
              <div class="v" id="kpiNet">â€”</div>
              <div class="t">Ä°nternet</div>
            </div>
          </div>

          <div class="hr"></div>

          <button class="btn" id="btnFlush">ğŸ“¤ Offline KayÄ±tlarÄ± GÃ¶nder</button>
          <button class="btn danger" id="btnWipe">ğŸ—‘ï¸ Offline KuyruÄŸu Sil</button>

          <div class="status" id="flushBox">Bekleyen kayÄ±t yoksa burada â€œ0â€ gÃ¶rÃ¼rsÃ¼n.</div>

          <div class="note" style="margin-top:10px;">
            Depoda internet yoksa sorun deÄŸil: kayÄ±tlar cihazda kalÄ±r. Ä°nternet gelince â€œOffline KayÄ±tlarÄ± GÃ¶nderâ€ ile yollarsÄ±n.
          </div>

        </div>
      </div>

      <div class="card">
        <h2>âš™ï¸ Backend (GAS) AyarÄ±</h2>
        <div class="body">
          <label>Apps Script Web App (â€¦/exec) URL</label>
          <input id="gasUrl" placeholder="https://script.google.com/macros/s/XXXX/exec" />

          <div class="actions">
            <button class="btn secondary" id="btnSaveGAS">ğŸ’¾ Kaydet</button>
            <button class="btn secondary" id="btnTestGAS">ğŸ” Test</button>
          </div>

          <div class="mini">
            Test: GET atar. â€œOKâ€ dÃ¶nerse baÄŸlantÄ± tamam.
          </div>

          <div class="status" id="gasBox">HenÃ¼z test edilmedi.</div>

          <div class="smallline"></div>

          <div class="mini">
            Ä°pucu: GAS tarafÄ±nda deÄŸiÅŸiklik yaptÄ±ysan tekrar â€œDaÄŸÄ±t â†’ Yeni daÄŸÄ±tÄ±mâ€ ile yeni sÃ¼rÃ¼m Ã§Ä±kman gerekir.
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<script>
(() => {
  // ====== STORAGE KEYS ======
  const KEY_GAS = "spradon_gas_url";
  const KEY_Q   = "spradon_security_offline_queue_v1";

  // ====== DEFAULTS ======
  const DEFAULT_GAS_URL = ""; // istersen buraya sabit URL yazabilirsin.

  // ====== DOM ======
  const el = (id) => document.getElementById(id);

  const netTxt   = el("netTxt");
  const qTxt     = el("qTxt");
  const kpiQueue = el("kpiQueue");
  const kpiNet   = el("kpiNet");
  const clockTxt = el("clockTxt");

  const personel   = el("personel");
  const personelId = el("personelId");
  const birim      = el("birim");
  const tarih      = el("tarih");
  const notTxt     = el("not");
  const fotoInput  = el("foto");

  const statusBox  = el("statusBox");
  const flushBox   = el("flushBox");
  const gasBox     = el("gasBox");
  const gasUrlInp  = el("gasUrl");

  const btnSend       = el("btnSend");
  const btnSaveOffline= el("btnSaveOffline");
  const btnClearForm  = el("btnClearForm");
  const btnFlush      = el("btnFlush");
  const btnWipe       = el("btnWipe");
  const btnSaveGAS    = el("btnSaveGAS");
  const btnTestGAS    = el("btnTestGAS");

  const previewWrap = el("photoPreview");

  // ====== HELPERS ======
  const nowISODate = () => new Date().toISOString().slice(0,10);

  function setStatus(msg, kind="") {
    statusBox.className = "status " + (kind || "");
    statusBox.textContent = msg;
  }
  function setFlush(msg, kind="") {
    flushBox.className = "status " + (kind || "");
    flushBox.textContent = msg;
  }
  function setGas(msg, kind="") {
    gasBox.className = "status " + (kind || "");
    gasBox.textContent = msg;
  }

  function loadQueue() {
    try { return JSON.parse(localStorage.getItem(KEY_Q) || "[]"); }
    catch { return []; }
  }
  function saveQueue(q) {
    localStorage.setItem(KEY_Q, JSON.stringify(q));
    refreshBadges();
  }

  function getGasUrl() {
    return (localStorage.getItem(KEY_GAS) || DEFAULT_GAS_URL || "").trim();
  }
  function setGasUrl(url) {
    localStorage.setItem(KEY_GAS, (url || "").trim());
  }

  function refreshBadges() {
    const online = navigator.onLine;
    netTxt.textContent = online ? "Online" : "Offline";
    netTxt.style.color = online ? "var(--ok)" : "var(--warn)";
    kpiNet.textContent = online ? "Online" : "Offline";
    kpiNet.style.color = online ? "var(--ok)" : "var(--warn)";

    const q = loadQueue();
    qTxt.textContent = String(q.length);
    kpiQueue.textContent = String(q.length);
  }

  function tickClock(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    clockTxt.textContent = ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())};
  }

  // ====== IMAGE: read + resize to base64 ======
  function fileToBase64Resized(file, maxW=1280, maxH=1280, quality=0.78) {
    return new Promise((resolve, reject) => {
      try{
        if (!file) return resolve(null);

        // Some iOS photos come as HEIC; browsers may not decode it.
        const isHeic = (file.type || "").toLowerCase().includes("heic") || (file.name || "").toLowerCase().endsWith(".heic");
        if (isHeic) {
          return reject(new Error("HEIC formatÄ± bazÄ± cihazlarda okunamayabilir. JPG/PNG deneyin."));
        }

        const reader = new FileReader();
        reader.onerror = () => reject(new Error("Foto okunamadÄ± (FileReader)."));
        reader.onload = () => {
          const img = new Image();
          img.onerror = () => reject(new Error("Foto okunamadÄ± (Image decode)."));
          img.onload = () => {
            const { width:w, height:h } = img;
            let tw = w, th = h;

            const ratio = Math.min(maxW / w, maxH / h, 1);
            tw = Math.round(w * ratio);
            th = Math.round(h * ratio);

            const canvas = document.createElement("canvas");
            canvas.width = tw; canvas.height = th;
            const ctx = canvas.getContext("2d", { alpha:false });

            ctx.drawImage(img, 0, 0, tw, th);

            const out = canvas.toDataURL("image/jpeg", quality);
            resolve(out);
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      }catch(err){
        reject(new Error("Foto okunamadÄ±: " + (err?.message || err)));
      }
    });
  }

  async function buildPhotoPayload(files) {
    const list = [];
    if (!files || !files.length) return list;

    for (let i=0; i<files.length; i++){
      const f = files[i];
      const b64 = await fileToBase64Resized(f);
      // convert "data:image/jpeg;base64,AAAA" -> AAAA
      const base64 = (b64 || "").split(",")[1] || "";
      list.push({
        name: f.name || (foto_${Date.now()}_${i}.jpg),
        mime: "image/jpeg",
        base64
      });
    }
    return list;
  }

  function renderPreview(photoList){
    if (!photoList || !photoList.length){
      previewWrap.style.display = "none";
      previewWrap.innerHTML = "";
      return;
    }
    previewWrap.style.display = "grid";
    previewWrap.innerHTML = photoList.map((p,idx)=>`
      <div class="thumb">
        <img alt="foto ${idx+1}" src="data:image/jpeg;base64,${p.base64}">
        <div class="cap">${p.name || ("Foto " + (idx+1))}</div>
      </div>
    `).join("");
  }

  // ====== PAYLOAD ======
  function collectBasePayload(){
    const p = (personel.value || "").trim();
    const pid = (personelId.value || "").trim();
    const b = birim.value || "GÃ¼venlik";
    const t = tarih.value || nowISODate();
    const n = (notTxt.value || "").trim();

    return {
      source: "security",
      personel: p,
      personelId: pid,
      birim: b,
      tarih: t,
      not: n,
      ts: new Date().toISOString()
    };
  }

  function validate(payload){
    // Security sayfasÄ±nda minimum: birim + tarih (personel zorunlu deÄŸil)
    if (!payload.birim) return "Birim boÅŸ olamaz.";
    if (!payload.tarih) return "Tarih boÅŸ olamaz.";
    return "";
  }

  // ====== NETWORK: GAS ======
  async function gasGetTest(url){
    const r = await fetch(url, { method:"GET", cache:"no-store" });
    let txt = await r.text();
    // try json
    try { return JSON.parse(txt); } catch { return { ok:r.ok, msg:txt }; }
  }

  async function gasPost(url, payload){
    const r = await fetch(url, {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload),
      cache:"no-store"
    });
    const txt = await r.text();
    try { return JSON.parse(txt); } catch { return { ok:r.ok, msg:txt }; }
  }

  async function sendOne(item){
    const url = getGasUrl();
    if (!url) throw new Error("GAS URL tanÄ±mlÄ± deÄŸil (Ayar kÄ±smÄ±ndan kaydet).");

    // gÃ¶nderim
    const res = await gasPost(url, item);

    // farklÄ± backend'ler farklÄ± alan dÃ¶ndÃ¼rebilir
    const ok = !!(res && (res.ok === true || res.success === true || res.status === "ok"));
    if (!ok) {
      throw new Error("Backend hata verdi: " + (res?.msg || res?.message || JSON.stringify(res)));
    }
    return res;
  }

  async function flushQueue(){
    const q = loadQueue();
    if (!q.length){
      setFlush("GÃ¶nderilecek offline kayÄ±t yok.", "ok");
      return;
    }
    if (!navigator.onLine){
      setFlush("Ä°nternet yok. Online olunca tekrar dene.", "warn");
      return;
    }

    let okCount = 0;
    const failed = [];
    for (let i=0; i<q.length; i++){
      try{
        await sendOne(q[i]);
        okCount++;
      }catch(err){
        failed.push(q[i]);
      }
    }
    saveQueue(failed);

    if (failed.length === 0){
      setFlush(âœ… Hepsi gÃ¶nderildi. GÃ¶nderilen: ${okCount}, "ok");
    }else{
      setFlush(âš ï¸ KÄ±smi gÃ¶nderim: gÃ¶nderilen ${okCount}, baÅŸarÄ±sÄ±z ${failed.length}. (KayÄ±tlar cihazda tutuldu, tekrar deneyebilirsin.), "warn");
    }
  }

  // ====== EVENTS ======
  btnSaveGAS.addEventListener("click", () => {
    const u = (gasUrlInp.value || "").trim();
    setGasUrl(u);
    setGas("âœ… Kaydedildi.", "ok");
  });

  btnTestGAS.addEventListener("click", async () => {
    const u = (gasUrlInp.value || "").trim() || getGasUrl();
    if (!u) { setGas("âŒ GAS URL boÅŸ.", "bad"); return; }
    try{
      setGas("Test ediliyorâ€¦", "");
      const res = await gasGetTest(u);
      const ok = !!(res && (res.ok === true || res.msg === "OK" || res.status === "ok"));
      setGas(ok ? ("âœ… Cevap geldi (OK)\n" + JSON.stringify(res)) : ("âš ï¸ Cevap geldi ama beklenmeyen\n" + JSON.stringify(res)), ok ? "ok" : "warn");
    }catch(err){
      setGas("âŒ Test baÅŸarÄ±sÄ±z: " + (err?.message || err), "bad");
    }
  });

  btnClearForm.addEventListener("click", () => {
    notTxt.value = "";
    fotoInput.value = "";
    renderPreview([]);
    setStatus("Form temizlendi.", "");
  });

  btnWipe.addEventListener("click", () => {
    if (!confirm("Offline kuyruÄŸu silinsin mi?")) return;
    saveQueue([]);
    setFlush("ğŸ—‘ï¸ Offline kuyruk silindi.", "ok");
  });

  btnFlush.addEventListener("click", async () => {
    btnFlush.disabled = true;
    try { await flushQueue(); }
    finally { btnFlush.disabled = false; }
  });

  btnSaveOffline.addEventListener("click", async () => {
    try{
      const base = collectBasePayload();
      const err = validate(base);
      if (err) { setStatus("âŒ " + err, "bad"); return; }

      setStatus("Foto okunuyorâ€¦", "");
      const photos = await buildPhotoPayload(fotoInput.files);

      const item = { ...base, photos };
      const q = loadQueue();
      q.push(item);
      saveQueue(q);

      renderPreview(photos);
      setStatus(ğŸ“¦ Offline kaydedildi. (Bekleyen: ${q.length}), "ok");
    }catch(err){
      setStatus("âŒ " + (err?.message || err), "bad");
    }
  });

  btnSend.addEventListener("click", async () => {
    btnSend.disabled = true;
    try{
      const base = collectBasePayload();
      const err = validate(base);
      if (err) { setStatus("âŒ " + err, "bad"); return; }

      setStatus("Foto okunuyorâ€¦", "");
      const photos = await buildPhotoPayload(fotoInput.files);
      renderPreview(photos);

      const item = { ...base, photos };

      //

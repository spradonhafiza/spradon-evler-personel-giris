<!doctype html>
<html lang="tr" translate="no" class="notranslate">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="google" content="notranslate" />
  <meta http-equiv="content-language" content="tr" />
  <title>Spradon HafÄ±za â€¢ GÃ¼venlik</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.72);
      --ok:#2ecc71;
      --warn:#f39c12;
      --bad:#e74c3c;
      --btn:#2563eb;
      --btn2:rgba(255,255,255,.10);
      --line:rgba(255,255,255,.12);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(37,99,235,.25), transparent 60%),
        radial-gradient(1000px 700px at 110% 0%, rgba(46,204,113,.18), transparent 60%),
        radial-gradient(900px 700px at 30% 120%, rgba(243,156,18,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      padding:18px;
    }
    a{color:var(--text)}
    .wrap{max-width:980px;margin:0 auto}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      flex-wrap:wrap;margin-bottom:14px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg, rgba(37,99,235,.9), rgba(46,204,113,.85));
      display:grid;place-items:center;font-weight:800;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .title{font-weight:800}
    .subtitle{color:var(--muted);font-size:12px;margin-top:2px}
    .chips{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{
      padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      background:rgba(255,255,255,.04);font-size:12px;color:var(--muted)
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.22);
    }
    .card h3{margin:0 0 10px 0;font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);
      color:var(--text);outline:none;
    }
    textarea{min-height:88px;resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:0;border-radius:12px;padding:10px 12px;
      cursor:pointer;font-weight:700;color:var(--text);
      background:var(--btn);
    }
    button.secondary{background:var(--btn2);border:1px solid var(--line);font-weight:700}
    button.danger{background:rgba(231,76,60,.18);border:1px solid rgba(231,76,60,.45)}
    .note{color:var(--muted);font-size:12px;line-height:1.35}
    .status{
      margin-top:10px;padding:10px 12px;border-radius:12px;
      border:1px dashed var(--line);color:var(--muted);font-size:12px;
      background:rgba(0,0,0,.14);
      white-space:pre-wrap;
    }
    .kpi{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px
    }
    .kpi .box{
      background:rgba(0,0,0,.14);
      border:1px solid var(--line);
      border-radius:14px;padding:10px 12px;
    }
    .kpi .big{font-size:22px;font-weight:900;margin:0}
    .kpi .small{margin:4px 0 0;color:var(--muted);font-size:12px}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .tiny{font-size:11px;color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap notranslate" translate="no">
  <div class="top">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <div class="title">Spradon HafÄ±za â€¢ GÃ¼venlik</div>
        <div class="subtitle">Foto + not + offline kayÄ±t (internet gelince toplu gÃ¶nderim)</div>
      </div>
    </div>

    <div class="chips">
      <div class="chip">Durum: <b id="netChip">â€”</b></div>
      <div class="chip">Offline kuyruk: <b id="qChip">0</b></div>
    </div>
  </div>

  <div class="grid">
    <!-- SOL: KayÄ±t -->
    <div class="card">
      <h3>ğŸ—‚ï¸ KayÄ±t OluÅŸtur</h3>

      <div class="row">
        <div>
          <label>Personel AdÄ±</label>
          <input id="personel" autocomplete="off" placeholder="Ã–rn: AkÄ±n" />
        </div>
        <div>
          <label>Personel ID / Sicil</label>
          <input id="personelId" autocomplete="off" placeholder="Ã–rn: A101" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Birim</label>
          <select id="birim">
            <option>GÃ¼venlik</option>
            <option>Teknik</option>
            <option>Temizlik</option>
            <option>YÃ¶netim</option>
            <option>DiÄŸer</option>
          </select>
        </div>
        <div>
          <label>Tarih</label>
          <input id="tarih" type="date" />
        </div>
      </div>

      <label>Not / AÃ§Ä±klama</label>
      <textarea id="not" placeholder="Ã–rn: 550 ada giriÅŸ kapÄ±sÄ±..."></textarea>

      <label>FotoÄŸraf(lar) (opsiyonel)</label>
      <input id="foto" type="file" accept="image/*" multiple />

      <div class="tiny" style="margin-top:8px;">
        Not: FotoÄŸraflar otomatik kÃ¼Ã§Ã¼ltÃ¼lÃ¼r (hÄ±z + kota iÃ§in). Ã‡ok bÃ¼yÃ¼k/HEIC dosyalarda bazÄ± cihazlar desteklemeyebilir.
      </div>

      <div class="btns">
        <button id="btnSend">âœ… Kaydet & GÃ¶nder</button>
        <button id="btnOffline" class="secondary">ğŸ“¦ Sadece Offline Kaydet</button>
        <button id="btnClearForm" class="secondary">ğŸ§¹ Formu Temizle</button>
      </div>

      <div id="statusLeft" class="status">HazÄ±r.</div>
    </div>

    <!-- SAÄ: Offline & Backend -->
    <div class="card">
      <h3>ğŸ§  Offline & GÃ¶nderim</h3>

      <div class="kpi">
        <div class="box">
          <p class="big" id="qCount">0</p>
          <p class="small">Cihazda bekleyen kayÄ±t</p>
        </div>
        <div class="box">
          <p class="big" id="netState">â€”</p>
          <p class="small">Ä°nternet</p>
        </div>
      </div>

      <div class="btns">
        <button id="btnFlush" class="secondary">ğŸšš Offline KayÄ±tlarÄ± GÃ¶nder</button>
        <button id="btnWipe" class="danger">ğŸ—‘ï¸ Offline KuyruÄŸu Sil</button>
      </div>

      <div id="statusRight" class="status">Bekleyen kayÄ±t yoksa burada â€œ0â€ gÃ¶rÃ¼rsÃ¼n.</div>

      <div class="hr"></div>

      <h3>âš™ï¸ Backend (GAS) AyarÄ±</h3>

      <label>Apps Script Web App (â€¦/exec) URL</label>
      <input id="gasUrl" autocomplete="off" placeholder="https://script.google.com/macros/s/XXXX/exec" />

      <div class="btns">
        <button id="btnSaveUrl" class="secondary">ğŸ’¾ Kaydet</button>
        <button id="btnTest" class="secondary">ğŸ” Test</button>
      </div>

      <div class="note">
        Test: <b>GET</b> atar, â€œOKâ€ dÃ¶nerse baÄŸlantÄ± tamam.<br/>
        <span class="warn">Ã–nemli:</span> GÃ¶nderimde <b>preflight tetiklememek</b> iÃ§in JSON header kullanmÄ±yoruz.
      </div>

      <div id="statusUrl" class="status">HenÃ¼z test edilmedi.</div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // --- Anti-translate (tarayÄ±cÄ± Ã§evirisi iÃ§in ek Ã¶nlem)
  document.documentElement.setAttribute("translate","no");
  document.documentElement.classList.add("notranslate");
  document.body.setAttribute("translate","no");
  document.body.classList.add("notranslate");

  // --- Storage keys
  const KEY_URL = "spradon_gas_url";
  const KEY_QUEUE = "spradon_offline_queue_v1";

  // --- UI refs
  const $ = (id) => document.getElementById(id);

  const el = {
    personel: $("personel"),
    personelId: $("personelId"),
    birim: $("birim"),
    tarih: $("tarih"),
    not: $("not"),
    foto: $("foto"),

    btnSend: $("btnSend"),
    btnOffline: $("btnOffline"),
    btnClearForm: $("btnClearForm"),

    btnFlush: $("btnFlush"),
    btnWipe: $("btnWipe"),

    gasUrl: $("gasUrl"),
    btnSaveUrl: $("btnSaveUrl"),
    btnTest: $("btnTest"),

    statusLeft: $("statusLeft"),
    statusRight: $("statusRight"),
    statusUrl: $("statusUrl"),

    qCount: $("qCount"),
    qChip: $("qChip"),
    netState: $("netState"),
    netChip: $("netChip"),
  };

  // default date today
  if (!el.tarih.value) {
    const d = new Date();
    const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    el.tarih.value = iso;
  }

  // Load saved URL
  el.gasUrl.value = (localStorage.getItem(KEY_URL) || "").trim();

  // --- Helpers
  const nowISO = () => new Date().toISOString();

  function setLeft(msg, cls="") {
    el.statusLeft.className = "status " + cls;
    el.statusLeft.textContent = msg;
  }
  function setRight(msg, cls="") {
    el.statusRight.className = "status " + cls;
    el.statusRight.textContent = msg;
  }
  function setUrlStatus(msg, cls="") {
    el.statusUrl.className = "status " + cls;
    el.statusUrl.textContent = msg;
  }

  function loadQueue() {
    try { return JSON.parse(localStorage.getItem(KEY_QUEUE) || "[]") || []; }
    catch { return []; }
  }
  function saveQueue(q) {
    localStorage.setItem(KEY_QUEUE, JSON.stringify(q || []));
    renderQueue();
  }

  function renderNet() {
    const online = navigator.onLine;
    el.netState.textContent = online ? "Online" : "Offline";
    el.netState.className = "big " + (online ? "ok" : "warn");

    el.netChip.textContent = online ? "Online" : "Offline";
    el.netChip.className = online ? "ok" : "warn";
  }

  function renderQueue() {
    const q = loadQueue();
    el.qCount.textContent = String(q.length);
    el.qChip.textContent = String(q.length);
  }

  window.addEventListener("online", () => { renderNet(); });
  window.addEventListener("offline", () => { renderNet(); });

  renderNet();
  renderQueue();

  function cleanUrl(u) {
    u = (u || "").trim();
    if (!u) return "";
    // allow googleusercontent echo too
    return u;
  }

  // --- Image handling: convert to jpeg base64 (small)
  function fileToJpegBase64(file, maxW=1280, quality=0.82) {
    return new Promise((resolve, reject) => {
      // Some HEIC not readable in browser -> reject gracefully
      const fr = new FileReader();
      fr.onerror = () => reject(new Error("Foto okunamadÄ± (FileReader)."));
      fr.onload = () => {
        const img = new Image();
        img.onload = () => {
          try {
            const ratio = Math.min(1, maxW / img.width);
            const w = Math.max(1, Math.round(img.width * ratio));
            const h = Math.max(1, Math.round(img.height * ratio));
            const c = document.createElement("canvas");
            c.width = w; c.height = h;
            const ctx = c.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = c.toDataURL("image/jpeg", quality);
            const b64 = dataUrl.split(",")[1] || "";
            resolve({
              base64: b64,
              mimeType: "image/jpeg",
              name: (file.name || "photo.jpg").replace(/\.(heic|heif)$/i, ".jpg")
            });
          } catch (e) {
            reject(new Error("Foto iÅŸlenemedi (canvas)."));
          }
        };
        img.onerror = () => reject(new Error("Foto okunamadÄ± (Image decode)."));
        img.src = fr.result;
      };
      fr.readAsDataURL(file);
    });
  }

  async function readPhotos(files) {
    const arr = Array.from(files || []);
    if (!arr.length) return [];
    const out = [];
    for (const f of arr) {
      try {
        out.push(await fileToJpegBase64(f));
      } catch (e) {
        // Continue, but mark error
        throw e;
      }
    }
    return out;
  }

  function buildRecord(photosArr) {
    const personel = (el.personel.value || "").trim();
    const personelId = (el.personelId.value || "").trim();
    const birim = (el.birim.value || "").trim();
    const tarih = (el.tarih.value || "").trim();
    const note = (el.not.value || "").trim();

    // Minimal validations
    if (!personel && !personelId) {
      throw new Error("Personel AdÄ± veya Personel ID gir.");
    }
    if (!tarih) {
      throw new Error("Tarih seÃ§.");
    }

    return {
      source: "web",
      ts: nowISO(),
      personel,
      personelId,
      birim,
      tarih,
      not: note,
      fotograflar: photosArr || []
    };
  }

  // --- SEND (NO PREFLIGHT)
  // IMPORTANT: Do NOT set Content-Type: application/json
  // We'll send raw JSON string as text/plain (default) to avoid OPTIONS preflight to GAS.
  async function postToGAS(url, payloadObj) {
    const bodyText = JSON.stringify(payloadObj);

    const res = await fetch(url, {
      method: "POST",
      // headers intentionally omitted (preflight avoidance)
      body: bodyText,
      cache: "no-store",
      redirect: "follow",
    });

    // If GAS returns text/json
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }

    if (!res.ok) {
      const msg = (data && (data.msg || data.error)) ? (data.msg || data.error) : ("HTTP " + res.status);
      throw new Error(msg);
    }
    // Support various response shapes
    if (data && (data.ok === true || data.success === true)) return data;
    if (data && data.raw && String(data.raw).includes("OK")) return { ok:true, raw:data.raw };
    return data || { ok:true };
  }

  async function testGET(url) {
    const u = url + (url.includes("?") ? "&" : "?") + "ping=1&t=" + Date.now();
    const res = await fetch(u, { method:"GET", cache:"no-store" });
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch { data = { raw:text }; }
    if (!res.ok) throw new Error("HTTP " + res.status);
    return data;
  }

  // --- Actions
  el.btnSaveUrl.addEventListener("click", () => {
    const u = cleanUrl(el.gasUrl.value);
    localStorage.setItem(KEY_URL, u);
    setUrlStatus(u ? "âœ… Kaydedildi." : "âš ï¸ URL boÅŸ.", u ? "ok" : "warn");
  });

  el.btnTest.addEventListener("click", async () => {
    try {
      const u = cleanUrl(el.gasUrl.value);
      if (!u) throw new Error("URL boÅŸ. /exec linkini yapÄ±ÅŸtÄ±r.");
      localStorage.setItem(KEY_URL, u);
      setUrlStatus("Test ediliyor...", "");
      const data = await testGET(u);
      setUrlStatus("âœ… Cevap geldi.\n" + JSON.stringify(data, null, 2), "ok");
    } catch (e) {
      setUrlStatus("âŒ Test baÅŸarÄ±sÄ±z: " + (e.message || e), "bad");
    }
  });

  el.btnClearForm.addEventListener("click", () => {
    el.personel.value = "";
    el.personelId.value = "";
    el.not.value = "";
    el.foto.value = "";
    setLeft("Form temizlendi.", "");
  });

  el.btnOffline.addEventListener("click", async () => {
    try {
      setLeft("Offline kaydediliyor...", "");
      const photos = await readPhotos(el.foto.files);
      const rec = buildRecord(photos);
      const q = loadQueue();
      q.push(rec);
      saveQueue(q);
      setLeft("âœ… KayÄ±t offline kuyruÄŸa eklendi. (Toplam: " + q.length + ")", "ok");
      setRight("Bekleyen kayÄ±t: " + q.length + "\nÄ°nternet gelince â€œOffline KayÄ±tlarÄ± GÃ¶nderâ€ ile yollarsÄ±n.", "");
    } catch (e) {
      setLeft("âŒ " + (e.message || e), "bad");
    }
  });

  el.btnSend.addEventListener("click", async () => {
    try {
      setLeft("HazÄ±rlanÄ±yor...", "");
      const url = cleanUrl(localStorage.getItem(KEY_URL) || el.gasUrl.value);
      if (!url) throw new Error("Backend URL yok. SaÄŸ alttan /exec linkini yapÄ±ÅŸtÄ±rÄ±p Kaydet.");

      const photos = await readPhotos(el.foto.files);
      const rec = buildRecord(photos);

      // If offline -> queue only
      if (!navigator.onLine) {
        const q = loadQueue();
        q.push(rec);
        saveQueue(q);
        setLeft("âœ… Ä°nternet yok: kayÄ±t offline kuyruÄŸa alÄ±ndÄ±. (Toplam: " + q.length + ")", "warn");
        return;
      }

      setLeft("GÃ¶nderiliyor...", "");
      const resp = await postToGAS(url, rec);
      setLeft("âœ… GÃ¶nderildi.\n" + JSON.stringify(resp, null, 2), "ok");
    } catch (e) {
      // If failed, put into queue for safety
      const msg = (e.message || e) + "";
      try {
        const photos = await readPhotos(el.foto.files);
        const rec = buildRecord(photos);
        const q = loadQueue();
        q.push(rec);
        saveQueue(q);
        setLeft("âš ï¸ GÃ¶nderilemedi, offline kuyruÄŸa aldÄ±m.\nHata: " + msg + "\nBekleyen: " + q.length, "warn");
      } catch (e2) {
        setLeft("âŒ " + msg, "bad");
      }
    }
  });

  el.btnFlush.addEventListener("click", async () => {
    const url = cleanUrl(localStorage.getItem(KEY_URL) || el.gasUrl.value);
    if (!url) {
      setRight("âŒ Backend URL yok. /exec linkini gir.", "bad");
      return;
    }
    if (!navigator.onLine) {
      setRight("âš ï¸ Ä°nternet yok. Online olunca tekrar dene.", "warn");
      return;
    }

    const q = loadQueue();
    if (!q.length) {
      setRight("Bekleyen kayÄ±t yok.", "");
      return;
    }

    let ok = 0, fail = 0;
    const remain = [];

    setRight("GÃ¶nderim baÅŸladÄ±... (Toplam: " + q.length + ")", "");

    for (let i=0; i<q.length; i++) {
      const item = q[i];
      try {
        // Single item send
        await postToGAS(url, item);
        ok++;
      } catch (e) {
        fail++;
        remain.push(item);
      }
    }

    saveQueue(remain);

    if (fail === 0) {
      setRight("âœ… Hepsi gÃ¶nderildi. GÃ¶nderilen: " + ok + " / " + (ok+fail), "ok");
    } else {
      setRight("âš ï¸ KÄ±smi gÃ¶nderim: gÃ¶nderilen " + ok + ", baÅŸarÄ±sÄ±z " + fail +
               ". (KayÄ±tlarÄ± cihazda tuttum, tekrar deneyebilirsin.)", "warn");
    }
  });

  el.btnWipe.addEventListener("click", () => {
    if (!confirm("Offline kuyruÄŸu tamamen silinsin mi?")) return;
    saveQueue([]);
    setRight("ğŸ—‘ï¸ Offline kuyruk silindi.", "");
  });

})();
</script>
</body>
</html>

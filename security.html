<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="google" content="notranslate">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spradon Hafıza – Güvenlik</title>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
h1 { font-size:20px; }
button { padding:10px 14px; margin-top:10px; }
input, textarea, select { width:100%; margin-top:6px; padding:8px; }
.log { margin-top:10px; font-size:13px; }
.ok { color:green; }
.err { color:red; }
</style>
</head>

<body>
<h1>Güvenlik Tespit Bildirimi</h1>

<label>Birim</label>
<select id="birim">
  <option value="Guvenlik">Güvenlik</option>
  <option value="Teknik">Teknik</option>
  <option value="Temizlik">Temizlik</option>
  <option value="Peyzaj">Peyzaj</option>
</select>

<label>Açıklama</label>
<textarea id="aciklama" placeholder="Kısa açıklama"></textarea>

<label>Fotoğraf</label>
<input type="file" id="foto" accept="image/*" capture="environment">

<button onclick="submitForm()">Gönder</button>

<div class="log" id="log"></div>

<script>
/**** CONFIG (DOLDURULMUŞ) ****/
const GAS_WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbxnORQbPdpPw9KuvskTWeT1LtucQPoeOqg6pn78BIYoHu8LBD8TpGCa8A0AuAhjqwPnxg/exec";

/**** OFFLINE STORE ****/
function getQueue(){
  return JSON.parse(localStorage.getItem("offlineQueue") || "[]");
}
function saveQueue(q){
  localStorage.setItem("offlineQueue", JSON.stringify(q));
}

/**** IMAGE ****/
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result.split(",")[1]);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/**** SEND ****/
async function send(payload){
  await fetch(GAS_WEBAPP_URL,{
    method:"POST",
    mode:"no-cors",
    body:JSON.stringify(payload)
  });
  return true;
}

/**** SUBMIT ****/
async function submitForm(){
  const birim = document.getElementById("birim").value;
  const aciklama = document.getElementById("aciklama").value;
  const fotoInput = document.getElementById("foto");
  const log = document.getElementById("log");

  let foto64 = "";
  if (fotoInput.files[0]){
    foto64 = await fileToBase64(fotoInput.files[0]);
  }

  const payload = {
    action: "TESPIT",
    birim,
    aciklama,
    foto: foto64,
    time: new Date().toISOString()
  };

  try{
    await send(payload);
    log.innerHTML = "<span class='ok'>Gönderildi</span>";
  }catch(e){
    const q = getQueue();
    q.push(payload);
    saveQueue(q);
    log.innerHTML = "<span class='err'>Offline kaydedildi</span>";
  }
}

/**** RESEND OFFLINE ****/
async function resendOffline(){
  let q = getQueue();
  if (!q.length) return;
  let sent = [];
  for (let i=0;i<q.length;i++){
    try{
      await send(q[i]);
      sent.push(i);
    }catch(e){}
  }
  q = q.filter((_,i)=>!sent.includes(i));
  saveQueue(q);
}

window.addEventListener("online", resendOffline);
</script>
</body>
</html>

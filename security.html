<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GÃ¼venlik Bildirimi (FotoÄŸraflÄ±)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    .kutu { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.08); max-width:520px; margin:0 auto 14px; }
    h2 { margin:0 0 10px; }
    label { font-weight:600; display:block; margin:10px 0 6px; }
    input, select, textarea, button { width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; font-size:16px; box-sizing:border-box; }
    textarea { min-height:90px; resize:vertical; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    button { cursor:pointer; border:none; font-weight:700; }
    .btn { background:#2563eb; color:#fff; }
    .btn2 { background:#e5e7eb; color:#111827; }
    .btnWarn { background:#0ea5e9; color:#fff; }
    .mini { font-size:13px; color:#6b7280; margin-top:6px; }
    .ok { color:#16a34a; font-weight:700; }
    .err { color:#dc2626; font-weight:700; }
    .warn { color:#b45309; font-weight:700; }
    .line { height:1px; background:#eee; margin:14px 0; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f4f6; font-size:13px; }
    .smallBtnRow { display:flex; gap:10px; }
    .smallBtnRow button { width:auto; flex:1; }
    .kv { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; background:#0b1220; color:#c7d2fe; padding:10px; border-radius:10px; overflow:auto; }
  </style>
</head>

<body>

  <!-- AYAR -->
  <script>
    // âœ… BurayÄ± doldur: GAS Web App /exec linkin
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxnORQbPdpPw9KuvskTWeT1LtucQPoeOqg6pn78BIYoHu8LBD8TpGCa8A0AuAhjqwPnxg/exec";

    const OFFLINE_KEY = "spradon_offline_guvenlik_v1";

    function $(id){ return document.getElementById(id); }

    function setStatus(type, msg, extraObj){
      const el = $("durum");
      el.className = (type==="ok") ? "ok" : (type==="warn" ? "warn" : "err");
      el.textContent = msg;
      const dbg = $("debug");
      if(extraObj){
        dbg.style.display = "block";
        dbg.textContent = JSON.stringify(extraObj, null, 2);
      } else {
        dbg.style.display = "none";
        dbg.textContent = "";
      }
    }

    function isOnline(){
      return navigator.onLine;
    }

    function loadOffline(){
      try{
        return JSON.parse(localStorage.getItem(OFFLINE_KEY) || "[]");
      }catch(e){
        return [];
      }
    }

    function saveOffline(list){
      localStorage.setItem(OFFLINE_KEY, JSON.stringify(list || []));
      renderOfflineCount();
    }

    function pushOffline(item){
      const list = loadOffline();
      list.push(item);
      saveOffline(list);
    }

    function renderOfflineCount(){
      const n = loadOffline().length;
      $("offlineCount").textContent = n;
    }

    function nowIso(){
      return new Date().toISOString();
    }

    function toYMD(iso){
      try { return iso.slice(0,10); } catch(e){ return ""; }
    }

    // DosyayÄ± base64 DataURL olarak oku
    function readFileAsDataURL(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(String(r.result || ""));
        r.onerror = ()=> reject(new Error("FILE_READ_ERROR"));
        r.readAsDataURL(file);
      });
    }

    // DataURL -> { base64, mimeType, name }
    function dataUrlToBase64Obj(dataUrl, nameFallback){
      // data:image/jpeg;base64,XXXX
      const s = String(dataUrl || "");
      const m = s.match(/^data:([^;]+);base64,(.*)$/);
      if(!m) return null;
      return { base64: m[2], mimeType: m[1], name: nameFallback || "foto.jpg" };
    }

    async function gasGetTest(){
      if(!GAS_URL || GAS_URL.indexOf("script.google.com") === -1){
        setStatus("err", "GAS linki tanÄ±mlÄ± deÄŸil / hatalÄ±.", { GAS_URL });
        return;
      }
      try{
        const r = await fetch(GAS_URL, { method:"GET" });
        const j = await r.json();
        setStatus("ok", "âœ… Cevap geldi (OK).", j);
      }catch(e){
        setStatus("err", "âŒ Test baÅŸarÄ±sÄ±z: Failed to fetch", { error: String(e) });
      }
    }

    // Tek kayÄ±t gÃ¶nder
    async function sendOne(payload){
      const r = await fetch(GAS_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      // GAS bazen text dÃ¶ner, biz gÃ¼vene alalÄ±m:
      const txt = await r.text();
      try { return JSON.parse(txt); } catch(e){ return { ok:false, msg:"NON_JSON_RESPONSE", raw: txt }; }
    }

    // Offline kayÄ±tlarÄ± gÃ¶nder
    async function sendOfflineAll(){
      if(!isOnline()){
        setStatus("warn", "âš ï¸ Ä°nternet yok. Offline kayÄ±tlar cihazda duruyor.");
        return;
      }
      const list = loadOffline();
      if(list.length === 0){
        setStatus("ok", "GÃ¶nderilecek offline kayÄ±t yok.");
        return;
      }

      let ok = 0, fail = 0;
      const keep = [];

      for(const item of list){
        try{
          const res = await sendOne(item);
          if(res && res.ok){
            ok++;
          } else {
            fail++;
            keep.push(item);
          }
        }catch(e){
          fail++;
          keep.push(item);
        }
      }

      saveOffline(keep);

      if(fail === 0){
        setStatus("ok", âœ… Offline gÃ¶nderim tamam: gÃ¶nderilen ${ok}, baÅŸarÄ±sÄ±z ${fail}.);
      } else {
        setStatus("warn", âš ï¸ KÄ±smi gÃ¶nderim: gÃ¶nderilen ${ok}, baÅŸarÄ±sÄ±z ${fail}. (KayÄ±tlar cihazda duruyor, tekrar deneyebilirsin.));
      }
    }

    async function handleSubmit(){
      // Zorunlular
      const personel = $("personel").value.trim();
      const personelId = $("personelId").value.trim();
      const birim = $("birim").value.trim();
      const aciklama = $("aciklama").value.trim();

      if(!personel || !birim){
        setStatus("err", "âŒ Personel ve Birim zorunlu.");
        return;
      }

      // Foto (opsiyonel ama seÃ§ildiyse mutlaka okunacak)
      const f = $("foto").files && $("foto").files[0] ? $("foto").files[0] : null;

      let fotoObj = null;
      if(f){
        try{
          const dataUrl = await readFileAsDataURL(f);
          fotoObj = dataUrlToBase64Obj(dataUrl, f.name);
          if(!fotoObj || !fotoObj.base64){
            setStatus("err", "âŒ Foto okunamadÄ± (base64 oluÅŸmadÄ±).");
            return;
          }
        }catch(e){
          setStatus("err", "âŒ Foto okunamadÄ±.");
          return;
        }
      }

      // Payload (GAS tarafÄ± esnek alan eÅŸleme yapÄ±yor diye tasarlamÄ±ÅŸtÄ±k)
      const payload = {
        kaynak: "web",
        tarih: toYMD(nowIso()),
        personel: personel,
        personelId: personelId || "",
        birim: birim,
        aciklama: aciklama || "",
        // Foto alanlarÄ± (GAS tarafÄ±nda photoBase64 / fotoBase64 / imageBase64 gibi yakalanÄ±yordu)
        photoBase64: fotoObj ? fotoObj.base64 : "",
        photoName: fotoObj ? (fotoObj.name || "foto.jpg") : "",
        photoMime: fotoObj ? (fotoObj.mimeType || "image/jpeg") : ""
      };

      // Online ise direkt gÃ¶nder, deÄŸilse offline kaydet
      if(!isOnline()){
        pushOffline(payload);
        setStatus("warn", "âœ… KayÄ±t alÄ±ndÄ± (offline). Ä°nternet gelince 'Offline KayÄ±tlarÄ± GÃ¶nder' ile yollarsÄ±n.");
        return;
      }

      try{
        const res = await sendOne(payload);
        if(res && res.ok){
          setStatus("ok", "âœ… KayÄ±t gÃ¶nderildi.");
          // Formu temizle
          $("aciklama").value = "";
          $("foto").value = "";
        } else {
          // GÃ¶nderemedi -> offlineâ€™a al
          pushOffline(payload);
          setStatus("warn", "âš ï¸ Sunucuya gidemedim. KayÄ±t offline'a alÄ±ndÄ±, internet gelince gÃ¶nderebilirsin.", res);
        }
      }catch(e){
        pushOffline(payload);
        setStatus("warn", "âš ï¸ BaÄŸlantÄ± hatasÄ±. KayÄ±t offline'a alÄ±ndÄ±, internet gelince gÃ¶nderebilirsin.", { error: String(e) });
      }
    }

    window.addEventListener("online", ()=>{
      renderOfflineCount();
    });
    window.addEventListener("offline", ()=>{
      renderOfflineCount();
    });
  </script>

  <div class="kutu">
    <h2>ğŸ›¡ï¸ GÃ¼venlik Bildirimi</h2>
    <div class="pill">Backend: <b>GAS</b> / Offline kayÄ±t: <b id="offlineCount">0</b></div>

    <label>Personel (zorunlu)</label>
    <input id="personel" placeholder="Ã–rn: AkÄ±n" value="AkÄ±n" />

    <label>Personel ID (opsiyonel)</label>
    <input id="personelId" placeholder="Ã–rn: A101" />

    <label>Birim (zorunlu)</label>
    <select id="birim">
      <option value="GÃ¼venlik">GÃ¼venlik</option>
      <option value="Teknik">Teknik</option>
      <option value="Temizlik">Temizlik</option>
      <option value="YÃ¶netim">YÃ¶netim</option>
    </select>

    <label>AÃ§Ä±klama</label>
    <textarea id="aciklama" placeholder="Bildirimi yaz..."></textarea>

    <label>FotoÄŸraf (opsiyonel)</label>
    <input id="foto" type="file" accept="image/*" />

    <div class="row" style="margin-top:12px;">
      <button class="btn" onclick="handleSubmit()">ğŸ“© GÃ¶nder</button>
      <button class="btn2" onclick="location.href='panel.html'">â†©ï¸ Panele DÃ¶n</button>
    </div>

    <div class="line"></div>

    <h3 style="margin:0 0 8px;">ğŸ§  Offline & GÃ¶nderim</h3>
    <div class="mini">
      Depoda internet Ã§ekmiyorsa sorun deÄŸil: kayÄ±tlar cihazda saklanÄ±r. Ä°nternet gelince aÅŸaÄŸÄ±daki butonla toplu gÃ¶nderirsin.
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btnWarn" onclick="sendOfflineAll()">ğŸ“¤ Offline KayÄ±tlarÄ± GÃ¶nder</button>
    </div>

    <div class="smallBtnRow" style="margin-top:10px;">
      <button class="btn2" onclick="localStorage.removeItem(OFFLINE_KEY); renderOfflineCount(); setStatus('ok','Offline kayÄ±tlar temizlendi.');">ğŸ§¹ Offline Temizle</button>
      <button class="btn2" onclick="gasGetTest()">ğŸ” GET Test</button>
    </div>

    <div class="line"></div>

    <div id="durum" class="mini">Durum mesajÄ± burada gÃ¶rÃ¼necek.</div>
    <pre id="debug" class="kv" style="display:none;"></pre>
  </div>

  <script>
    // ilk yÃ¼kleme
    renderOfflineCount();
    setStatus("ok", "HazÄ±r. GET Test ile baÄŸlantÄ±yÄ± doÄŸrulayabilirsin.");
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Spradon HafÄ±za â€“ Stok Ã‡Ä±kÄ±ÅŸ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f6fb;color:#1f2937}
    .container{max-width:1000px;margin:auto;padding:32px}
    h1{margin:0 0 6px 0;font-size:26px}
    .sub{color:#6b7280;font-size:14px;margin:0 0 18px 0}
    .card{background:#fff;border-radius:14px;padding:24px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid #e5e7eb;margin-bottom:18px}
    label{font-weight:bold;font-size:14px;display:block;margin-top:12px}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
    textarea{resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
    button{margin-top:18px;padding:12px 20px;border:none;border-radius:10px;background:#2563eb;color:#fff;font-size:15px;cursor:pointer}
    button.secondary{background:#6b7280;margin-left:10px}
    .hint{font-size:13px;color:#6b7280;margin-top:10px}
    .ok{display:none;background:#ecfdf5;color:#065f46;padding:12px;border-radius:10px;margin-top:14px}
    .warn{display:none;background:#fff7ed;color:#9a3412;padding:12px;border-radius:10px;margin-top:14px}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:6px 10px;border-radius:999px;font-size:12px;margin-top:10px}
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“¤ Stoktan ÃœrÃ¼n Ã‡Ä±kÄ±ÅŸÄ±</h1>
  <p class="sub">ÃœrÃ¼nÃ¼ kim aldÄ± (zorunlu) + miktar + aÃ§Ä±klama + (opsiyonel) foto. Ä°nternet yoksa cihazda saklar.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>ÃœrÃ¼n (zorunlu)</label>
        <input id="urun" type="text" placeholder="Ã–rn: 45'lik maÅŸon">
      </div>
      <div>
        <label>Birim (zorunlu)</label>
        <select id="birim">
          <option>Adet</option>
          <option>Kilo</option>
          <option>Litre</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Ã‡Ä±kÄ±ÅŸ MiktarÄ± (zorunlu)</label>
        <input id="miktar" type="number" min="0" step="1" placeholder="Ã–rn: 5">
      </div>
      <div>
        <label>Hangi ekip?</label>
        <select id="kategori">
          <option value="">SeÃ§iniz</option>
          <option>Teknik</option>
          <option>Temizlik</option>
          <option>GÃ¼venlik</option>
          <option>Peyzaj</option>
          <option>Saha</option>
          <option>Muhasebe/SatÄ±nalma</option>
        </select>
      </div>
    </div>

    <label>ÃœrÃ¼nÃ¼ Alan KiÅŸi (zorunlu)</label>
    <input id="kisi" type="text" placeholder="Ã–rn: AkÄ±n / Ali / Mehmet">

    <label>AÃ§Ä±klama (nerede kullanÄ±ldÄ±?)</label>
    <textarea id="aciklama" rows="3" placeholder="Ã–rn: 553 Ada â€“ blok giriÅŸ aydÄ±nlatma tamiri iÃ§in kullanÄ±ldÄ±"></textarea>

    <label>FotoÄŸraf (opsiyonel)</label>
    <input id="foto" type="file" accept="image/*">

    <div class="pill">ğŸ“Œ Not: Depoda internet Ã§ekmiyorsa sorun deÄŸilâ€”kayÄ±t yedekte kalÄ±r.</div>

    <button onclick="cikisKaydet()">Stoktan DÃ¼ÅŸ</button>
    <button class="secondary" onclick="location.href='stok.html'">â† Stok Paneline DÃ¶n</button>

    <div class="ok" id="okMsg">âœ” Ã‡Ä±kÄ±ÅŸ kaydedildi.</div>
    <div class="warn" id="warnMsg">âš  Ä°nternet yok. KayÄ±t cihazda saklandÄ±, baÄŸlantÄ± gelince gÃ¶nderilir.</div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ§ª Offline kayÄ±tlarÄ± ÅŸimdi gÃ¶nder</h3>
    <p class="sub" style="margin-top:0">Ä°nternet geldiÄŸinde bir tÄ±kla iÃ§eride kalan kayÄ±tlarÄ± backend'e yollar.</p>
    <button onclick="flushOffline()">Offline KayÄ±tlarÄ± GÃ¶nder</button>
    <div class="ok" id="flushOk">âœ” Offline kayÄ±tlar gÃ¶nderildi.</div>
  </div>
</div>

<script>
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwZGhMDzmSt8PaZsQfbVPOkcEtecD2R1ASJd-6bJUjzKnof6FGwtdkoVDk_fuoJ_AAp2g/exec";
  const OFFLINE_KEY_PREFIX = "stok_cikis_yedek_";

  function show(id, on=true){ document.getElementById(id).style.display = on ? "block" : "none"; }

  function fileToBase64(file){
    return new Promise((resolve, reject) => {
      if(!file) return resolve("");
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result).split(",")[1] || "");
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function cikisKaydet(){
    show("okMsg", false); show("warnMsg", false);

    const urun = document.getElementById("urun").value.trim();
    const birim = document.getElementById("birim").value;
    const miktar = Number(document.getElementById("miktar").value);
    const kategori = document.getElementById("kategori").value;
    const kisi = document.getElementById("kisi").value.trim();
    const aciklama = document.getElementById("aciklama").value.trim();
    const fotoFile = document.getElementById("foto").files[0];

    if(!urun || !kisi || !miktar || miktar <= 0){
      alert("ÃœrÃ¼n, miktar ve Ã¼rÃ¼nÃ¼ alan kiÅŸi zorunludur.");
      return;
    }

    const fotoBase64 = await fileToBase64(fotoFile);

    const payload = {
      action: "STOK_CIKIS",
      urun, birim, miktar,
      kategori,
      kisi,
      aciklama,
      foto: fotoBase64 ? { base64: fotoBase64, mimeType: fotoFile.type || "image/jpeg", name: fotoFile.name || "cikis.jpg" } : null,
      clientTime: new Date().toISOString()
    };

    try{
      const r = await fetch(BACKEND_URL, { method:"POST", body: JSON.stringify(payload) });
      const d = await r.json();
      show("okMsg", true);
      // Formu temizle
      document.getElementById("miktar").value = "";
      document.getElementById("aciklama").value = "";
      document.getElementById("foto").value = "";
    }catch(e){
      localStorage.setItem(OFFLINE_KEY_PREFIX + Date.now(), JSON.stringify(payload));
      show("warnMsg", true);
    }
  }

  async function flushOffline(){
    show("flushOk", false);
    const keys = [];
    for(let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if(k && k.startsWith(OFFLINE_KEY_PREFIX)) keys.push(k);
    }
    if(keys.length === 0){
      alert("Offline kayÄ±t yok.");
      return;
    }

    let sent = 0;
    for(const k of keys){
      try{
        const payload = JSON.parse(localStorage.getItem(k));
        const r = await fetch(BACKEND_URL, { method:"POST", body: JSON.stringify(payload) });
        await r.json();
        localStorage.removeItem(k);
        sent++;
      }catch(e){
        // bu key kalsÄ±n
      }
    }
    if(sent > 0) show("flushOk", true);
    alert("GÃ¶nderilen: " + sent + " / " + keys.length);
  }
</script>

</body>
</html>

<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spradon HafÄ±za â€¢ Stok Ã‡Ä±kÄ±ÅŸ</title>
<style>
:root{
  --bg:#f4f6fb; --text:#111827; --muted:#6b7280;
  --card:#ffffff; --line:#e5e7eb;
  --pri:#2563eb; --pri2:#1d4ed8; --gray:#e5e7eb;
  --ok:#16a34a; --warn:#b45309; --bad:#b91c1c;
  --r:16px; --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
h1{margin:0 0 6px;font-size:22px}
.sub{color:var(--muted);font-size:13px;margin-bottom:14px;line-height:1.4}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:860px){.grid{grid-template-columns:1fr}}
label{font-size:13px;font-weight:700;display:block;margin-top:10px}
input,select,textarea{
  width:100%;border:1px solid var(--line);border-radius:12px;
  padding:10px 12px;margin-top:6px;font-size:14px;background:#fff
}
textarea{min-height:92px;resize:vertical}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
button,a{
  border:0;border-radius:12px;padding:10px 14px;font-weight:800;
  cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px
}
.primary{background:var(--pri);color:#fff}
.primary:hover{background:var(--pri2)}
.gray{background:var(--gray);color:#111827}
.pill{font-size:12px;color:var(--muted)}
.msg{margin-top:10px;font-size:13px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.hr{height:1px;background:var(--line);margin:14px 0}
.small{font-size:12px;color:var(--muted);line-height:1.4}
kbd{background:#111827;color:#fff;border-radius:6px;padding:2px 6px;font-size:11px}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ“¦ Stoktan ÃœrÃ¼n Ã‡Ä±kÄ±ÅŸÄ±</h1>
    <div class="sub">
      <b>Zorunlu:</b> ÃœrÃ¼n + Ã‡Ä±kÄ±ÅŸ miktarÄ± + ÃœrÃ¼nÃ¼ alan kiÅŸi. <br>
      <span class="pill">Ä°nternet yoksa cihazda saklar. Ä°nternet gelince â€œOffline KayÄ±tlarÄ± GÃ¶nderâ€ ile yollar.</span>
    </div>

    <div class="grid">
      <!-- SOL: Ã‡Ä±kÄ±ÅŸ formu -->
      <div>
        <label>ÃœrÃ¼n (zorunlu)</label>
        <select id="urunSelect"></select>
        <div class="small">Listede yoksa alttan manuel yazabilirsin.</div>
        <input id="urunManual" placeholder="(Opsiyonel) Manuel Ã¼rÃ¼n adÄ±">

        <div class="grid">
          <div>
            <label>Ã‡Ä±kÄ±ÅŸ MiktarÄ± (zorunlu)</label>
            <input id="cikisMiktar" type="number" min="0" step="0.01" placeholder="Ã–rn: 5">
          </div>
          <div>
            <label>Birim (zorunlu)</label>
            <select id="birim">
              <option value="">SeÃ§iniz</option>
              <option>Adet</option>
              <option>Kutu</option>
              <option>Kg</option>
              <option>Litre</option>
            </select>
          </div>
        </div>

        <label>Hangi ekip?</label>
        <select id="ekip">
          <option value="">SeÃ§iniz</option>
          <option>Teknik</option>
          <option>Temizlik</option>
          <option>GÃ¼venlik</option>
          <option>Saha</option>
          <option>Muhasebe / SatÄ±n Alma</option>
        </select>

        <label>ÃœrÃ¼nÃ¼ Alan KiÅŸi (zorunlu)</label>
        <input id="alanKisi" placeholder="Ã–rn: AkÄ±n / Ali / Mehmet">

        <label>AÃ§Ä±klama (nerede kullanÄ±ldÄ±?)</label>
        <textarea id="aciklama" placeholder="Ã–rn: 553 Ada - blok giriÅŸi aydÄ±nlatma tamiri iÃ§in kullanÄ±ldÄ±"></textarea>

        <label>FotoÄŸraf (opsiyonel)</label>
        <input id="foto" type="file" accept="image/*">

        <div class="row">
          <button class="primary" onclick="stoktanDus()">â¬‡ï¸ Stoktan DÃ¼ÅŸ</button>
          <a class="gray" href="stok.html">â†©ï¸ Stok Paneline DÃ¶n</a>
        </div>

        <div id="formMsg" class="msg"></div>
      </div>

      <!-- SAÄ: Offline / Ayarlar -->
      <div>
        <div class="card" style="box-shadow:none;border-radius:14px">
          <b>ğŸ§  Offline & GÃ¶nderim</b>
          <div class="small">
            Depoda internet Ã§ekmiyorsa sorun deÄŸil: kayÄ±tlar cihazda saklanÄ±r. <br>
            Ä°nternet gelince aÅŸaÄŸÄ±daki butonla hepsini backendâ€™e gÃ¶nderirsin.
          </div>

          <div class="hr"></div>

          <button class="primary" onclick="flushOffline()">ğŸ“¤ Offline KayÄ±tlarÄ± GÃ¶nder</button>
          <div id="syncMsg" class="msg"></div>

          <div class="hr"></div>

          <b>âš™ï¸ Backend (GAS) AyarÄ±</b>
          <div class="small">
            Apps Script Web App (â€¦/exec) linkini buraya bir kez girmen yeter.
          </div>
          <input id="gasUrl" placeholder="https://script.google.com/macros/s/....../exec">
          <div class="row">
            <button class="gray" onclick="saveGas()">ğŸ’¾ Kaydet</button>
            <button class="gray" onclick="testGas()">ğŸ” Test</button>
          </div>
          <div class="small">
            Test: <kbd>GET</kbd> atar, cevap gelirse baÄŸlantÄ± tamam.
          </div>
          <div id="gasMsg" class="msg"></div>

          <div class="hr"></div>

          <b>ğŸ“Œ Not</b>
          <div class="small">
            ÃœrÃ¼n listesi, â€œÃœrÃ¼n KartÄ±â€ sayfasÄ±nda eklenen kayÄ±tlarÄ±n cihazdaki listesinden gelir.
            (AynÄ± cihazda kullanÄ±yorsan otomatik gÃ¶rÃ¼rsÃ¼n.)
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* LOCAL KEYS */
const KEY_PRODUCTS_QUEUE = "SPRADON_STOK_URUN_QUEUE_V1";   // Ã¼rÃ¼n kartÄ± (offline eklenenler)
const KEY_OUT_QUEUE      = "SPRADON_STOK_CIKIS_QUEUE_V1";  // Ã§Ä±kÄ±ÅŸ kayÄ±tlarÄ±
const KEY_GAS_URL        = "SPRADON_GAS_URL_V1";

/* Helpers */
const $ = (id)=>document.getElementById(id);
function setMsg(id, html){ $(id).innerHTML = html; }
function nowISO(){ return new Date().toISOString(); }

function loadJson(key, fallback){
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch(e){ return fallback; }
}
function saveJson(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/* PRODUCT DROPDOWN */
function rebuildProductSelect(){
  const sel = $("urunSelect");
  const productsQueue = loadJson(KEY_PRODUCTS_QUEUE, []);
  const uniq = new Map();

  // ÃœrÃ¼n kuyruÄŸundan (Ã¼rÃ¼n kartÄ±) isimleri Ã§ek
  productsQueue.forEach(p=>{
    const name = String(p.urun||"").trim();
    if(name) uniq.set(name, p);
  });

  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "SeÃ§iniz (Ã¼rÃ¼n kartlarÄ±ndan)";
  sel.appendChild(opt0);

  Array.from(uniq.keys()).sort((a,b)=>a.localeCompare(b,'tr')).forEach(name=>{
    const o = document.createElement("option");
    o.value = name;
    o.textContent = name;
    sel.appendChild(o);
  });
}

function pickProductName(){
  const a = $("urunSelect").value.trim();
  const b = $("urunManual").value.trim();
  // manuel doluysa manueli tercih et
  return b || a;
}

/* FOTO -> BASE64 */
function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    if(!file) return resolve("");
    const r = new FileReader();
    r.onload = ()=>resolve(String(r.result||""));
    r.onerror = ()=>reject(new Error("Dosya okunamadÄ±"));
    r.readAsDataURL(file);
  });
}

/* GAS URL */
function saveGas(){
  const url = $("gasUrl").value.trim();
  if(!url || !url.includes("/exec")){
    setMsg("gasMsg", "<div class='bad'>âš ï¸ Link boÅŸ ya da /exec deÄŸil gibi gÃ¶rÃ¼nÃ¼yor.</div>");
    return;
  }
  localStorage.setItem(KEY_GAS_URL, url);
  setMsg("gasMsg", "<div class='ok'>âœ… Kaydedildi.</div>");
}
function getGas(){
  return localStorage.getItem(KEY_GAS_URL) || "";
}
async function testGas(){
  const url = getGas() || $("gasUrl").value.trim();
  if(!url){
    setMsg("gasMsg", "<div class='bad'>âš ï¸ Ã–nce GAS linki gir.</div>");
    return;
  }
  try{
    setMsg("gasMsg", "<div class='warn'>â³ Test ediliyor...</div>");
    const res = await fetch(url, { method:"GET" });
    const txt = await res.text();
    setMsg("gasMsg", "<div class='ok'>âœ… Cevap geldi. (OK)</div><div class='small'>"+escapeHtml(txt).slice(0,220)+"</div>");
  }catch(e){
    setMsg("gasMsg", "<div class='bad'>âŒ Test baÅŸarÄ±sÄ±z: "+escapeHtml(String(e))+"</div>");
  }
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* MAIN: stoktan dÃ¼ÅŸ */
async function stoktanDus(){
  setMsg("formMsg","");

  const urun = pickProductName();
  const miktar = $("cikisMiktar").value;
  const birim = $("birim").value;
  const ekip = $("ekip").value;
  const alanKisi = $("alanKisi").value.trim();
  const aciklama = $("aciklama").value.trim();
  const fotoFile = $("foto").files[0] || null;

  if(!urun || !miktar || !birim || !alanKisi){
    setMsg("formMsg", "<div class='bad'>âš ï¸ ÃœrÃ¼n + Ã‡Ä±kÄ±ÅŸ miktarÄ± + Birim + ÃœrÃ¼nÃ¼ alan kiÅŸi zorunlu.</div>");
    return;
  }

  let foto64 = "";
  try{ foto64 = await fileToBase64(fotoFile); }
  catch(e){
    setMsg("formMsg", "<div class='bad'>âŒ Foto okunamadÄ±.</div>");
    return;
  }

  const rec = {
    action: "STOK_CIKIS",
    id: "CIK-" + Date.now(),
    urun, miktar: Number(miktar), birim,
    ekip, alanKisi,
    aciklama,
    fotoBase64: foto64 || "",
    zaman: nowISO()
  };

  // her durumda offline kuyruÄŸa yaz
  const q = loadJson(KEY_OUT_QUEUE, []);
  q.push(rec);
  saveJson(KEY_OUT_QUEUE, q);

  // form temizle
  $("cikisMiktar").value="";
  $("birim").value="";
  $("ekip").value="";
  $("alanKisi").value="";
  $("aciklama").value="";
  $("foto").value="";
  $("urunManual").value="";
  $("urunSelect").value="";

  setMsg("formMsg", "<div class='ok'>âœ… Ã‡Ä±kÄ±ÅŸ kaydÄ± alÄ±ndÄ± (offline). Ä°nternet varsa ÅŸimdi gÃ¶ndermeyi deniyorumâ€¦</div>");

  // online ise anÄ±nda flush dene
  await flushOffline(true);
}

/* flush offline */
async function flushOffline(silent=false){
  const url = getGas();
  const outQ = loadJson(KEY_OUT_QUEUE, []);
  const prodQ = loadJson(KEY_PRODUCTS_QUEUE, []);

  if(!outQ.length && !prodQ.length){
    if(!silent) setMsg("syncMsg", "<div class='warn'>â„¹ï¸ GÃ¶nderilecek offline kayÄ±t yok.</div>");
    return;
  }

  if(!url){
    if(!silent) setMsg("syncMsg", "<div class='bad'>âš ï¸ GAS linki tanÄ±mlÄ± deÄŸil. SaÄŸdan kaydet.</div>");
    return;
  }

  let sent = 0, fail = 0;

  // 1) ÃœrÃ¼n kartlarÄ± (varsa) â€” backendâ€™de action adÄ± STOK_URUN olarak gÃ¶nderiyoruz
  // (Backend tarafÄ±nda karÅŸÄ±lÄ±ÄŸÄ± yoksa bile, offline kayÄ±tlar cihazda kalÄ±r; zarar vermez.)
  if(prodQ.length){
    for(const p of prodQ){
      try{
        // DataURL -> base64
        let base64 = "";
        if(p.foto && String(p.foto).startsWith("data:")){
          base64 = String(p.foto).split(",")[1] || "";
        }
        const payload = {
          action: "STOK_URUN",
          urun: p.urun || "",
          birim: p.birim || "",
          baslangic: Number(p.miktar || 0),
          zaman: p.zaman || nowISO(),
          foto: base64 ? { base64: base64, mimeType: "image/jpeg", name: (p.urun||"urun")+".jpg" } : null
        };
        await postJson(url, payload);
        sent++;
      }catch(e){ fail++; }
    }
  }

  // 2) Ã‡Ä±kÄ±ÅŸ kayÄ±tlarÄ±
  if(outQ.length){
    for(const r of outQ){
      try{
        let base64 = "";
        if(r.fotoBase64 && String(r.fotoBase64).startsWith("data:")){
          base64 = String(r.fotoBase64).split(",")[1] || "";
        }
        const payload = {
          action: "STOK_CIKIS",
          id: r.id,
          urun: r.urun,
          miktar: r.miktar,
          birim: r.birim,
          ekip: r.ekip,
          alanKisi: r.alanKisi,
          aciklama: r.aciklama,
          zaman: r.zaman,
          foto: base64 ? { base64: base64, mimeType: "image/jpeg", name: r.id+".jpg" } : null
        };
        await postJson(url, payload);
        sent++;
      }catch(e){ fail++; }
    }
  }

  // EÄŸer hiÃ§ hata yoksa kuyruklarÄ± temizle (en temiz yÃ¶ntem)
  if(fail === 0){
    saveJson(KEY_PRODUCTS_QUEUE, []);
    saveJson(KEY_OUT_QUEUE, []);
    if(!silent) setMsg("syncMsg", "<div class='ok'>âœ… TÃ¼m offline kayÄ±tlar gÃ¶nderildi. ("+sent+")</div>");
    else setMsg("syncMsg", "<div class='ok'>âœ… GÃ¶nderildi. ("+sent+")</div>");
  }else{
    // Hata varsa: kayÄ±tlarÄ± SÄ°LME, gÃ¼venli olsun
    if(!silent) setMsg("syncMsg",
      "<div class='warn'>âš ï¸ KÄ±smi gÃ¶nderim: gÃ¶nderilen "+sent+", baÅŸarÄ±sÄ±z "+fail+
      ". (GÃ¼venlik iÃ§in kayÄ±tlarÄ± cihazda tuttum, tekrar deneyebilirsin.)</div>");
  }
}

async function postJson(url, obj){
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(obj)
  });
  // GAS bazen text dÃ¶ndÃ¼rÃ¼r, yine de oku
  const txt = await res.text();
  if(!res.ok) throw new Error("HTTP "+res.status+": "+txt);
  return txt;
}

/* init */
(function init(){
  const url = getGas();
  $("gasUrl").value = url || "";
  rebuildProductSelect();
})();
</script>
</body>
</html>

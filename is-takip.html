<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tespit Bildirimi</title>
  <style>
    :root{
      --bg:#f4f6f9; --card:#fff; --text:#101828; --muted:#667085;
      --border:#e5e7eb; --blue:#1d4ed8; --blue2:#2563eb;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --shadow:0 10px 28px rgba(16,24,40,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:var(--text);padding:18px}
    .wrap{max-width:980px;margin:0 auto}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:38px;height:38px;border-radius:12px;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
    h1{margin:0;font-size:18px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .card h2{margin:0 0 10px;font-size:15px}
    .sub{margin:0 0 12px;color:var(--muted);font-size:12px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--border);
      border-radius:12px;background:#fff;font-size:14px;outline:none
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){ .row{grid-template-columns:1fr 1fr} }
    .btn{
      width:100%;padding:12px 14px;border:0;border-radius:14px;cursor:pointer;
      background:var(--blue);color:#fff;font-weight:700;font-size:14px
    }
    .btn:hover{background:var(--blue2)}
    .btn2{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:14px;
      background:#fff;color:var(--text);font-weight:700;cursor:pointer
    }
    .btn2:hover{background:#f9fafb}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .msg{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:#fff;font-size:13px}
    .ok{border-color:#bbf7d0;background:#ecfdf5}
    .warn{border-color:#fde68a;background:#fffbeb}
    .bad{border-color:#fecaca;background:#fef2f2}
    .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;
      font-size:12px;color:var(--muted)
    }
    .mini{font-size:11px;color:var(--muted)}
    .files{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .fileItem{font-size:12px;color:var(--muted)}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .danger{color:var(--bad);font-weight:700}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <h1>Tespit Bildirim EkranÄ±</h1>
        <div class="mini">Tespit â†’ Ä°lgili birime dÃ¼ÅŸer. YapÄ±ldÄ±/ertelendi/eksik vb. gÃ¼ncellenebilir.</div>
      </div>
    </div>
    <div class="chip" id="whoChip">ğŸ‘¤ Oturum: -</div>
  </div>

  <div class="grid">
    <!-- SOL: TESPÄ°T OLUÅTUR -->
    <div class="card">
      <h2>ğŸ“Œ Yeni Tespit OluÅŸtur</h2>
      <p class="sub">Herkes tespit girebilir. Hedef birim seÃ§ilir, aÃ§Ä±klama + yer + fotoÄŸraf eklenebilir.</p>

      <div class="row">
        <div>
          <label>Hedef Birim</label>
          <select id="targetUnit">
            <option value="Teknik">Teknik</option>
            <option value="Temizlik">Temizlik</option>
            <option value="GÃ¼venlik">GÃ¼venlik</option>
            <option value="Saha">Saha</option>
            <option value="Peyzaj">Peyzaj</option>
            <option value="YÃ¶netim">YÃ¶netim</option>
          </select>
        </div>
        <div>
          <label>Ã–ncelik</label>
          <select id="priority">
            <option value="Normal">Normal</option>
            <option value="Acil">Acil</option>
            <option value="DÃ¼ÅŸÃ¼k">DÃ¼ÅŸÃ¼k</option>
          </select>
        </div>
      </div>

      <label>Konu / BaÅŸlÄ±k</label>
      <input id="title" placeholder="Ã–rn: 550 Ada yÃ¼rÃ¼yÃ¼ÅŸ yolu lamba yanmÄ±yor" />

      <label>Konum / Alan</label>
      <input id="location" placeholder="Ã–rn: 550 Ada - YÃ¼rÃ¼yÃ¼ÅŸ yolu - Blok A Ã¶nÃ¼" />

      <label>AÃ§Ä±klama</label>
      <textarea id="desc" placeholder="KÄ±sa ve net yaz: Ne gÃ¶rdÃ¼n? Ne gerekiyor?"></textarea>

      <label>FotoÄŸraf(lar) (opsiyonel) - En fazla 3 adet</label>
      <input id="photos" type="file" accept="image/*" multiple />
      <div class="files" id="fileList"></div>
      <div class="hint">Not: FotoÄŸraflar otomatik kÃ¼Ã§Ã¼ltÃ¼lerek gÃ¶nderilir (mobil iÃ§in hÄ±z).</div>

      <div class="sep"></div>

      <button class="btn" id="sendBtn">GÃ¶nder</button>
      <div id="sendMsg" class="msg" style="display:none"></div>
    </div>

    <!-- SAÄ: DURUM GÃœNCELLE -->
    <div class="card">
      <h2>âœ… Durum GÃ¼ncelle / SonuÃ§ Ekle</h2>
      <p class="sub">
        Teknik/Temizlik iÅŸleri iÃ§in: <b>YapÄ±ldÄ±</b>, <b>Ertelendi</b>, <b>Malzeme/ParÃ§a</b>, <b>DÄ±ÅŸ servis</b>, <b>Teklif</b> gibi seÃ§enekler.
        <span class="danger">GeliÅŸmiÅŸ seÃ§enekler</span> sadece <b>Teknik Åef</b> + <b>Saha Amir</b> iÃ§in aÃ§Ä±ktÄ±r.
      </p>

      <label>Tespit ID (varsa)</label>
      <input id="caseId" placeholder="Ã–rn: TSP-20260209-001 gibi (yoksa boÅŸ bÄ±rakabilirsin)" />

      <label>Ä°lgili Birim</label>
      <select id="caseUnit">
        <option value="Teknik">Teknik</option>
        <option value="Temizlik">Temizlik</option>
        <option value="GÃ¼venlik">GÃ¼venlik</option>
        <option value="Saha">Saha</option>
        <option value="Peyzaj">Peyzaj</option>
        <option value="YÃ¶netim">YÃ¶netim</option>
      </select>

      <label>Durum</label>
      <select id="status">
        <option value="YapÄ±ldÄ±">YapÄ±ldÄ±</option>
        <option value="Ertelendi">Ertelendi</option>
        <option value="YarÄ±n YapÄ±lacak">YarÄ±n YapÄ±lacak</option>
        <option value="Zaman Yetmedi">Zaman Yetmedi</option>
        <option value="Personel Eksik">Personel Eksik</option>
        <option value="Malzeme Eksik">Malzeme Eksik</option>
      </select>

      <div id="advancedBox" style="display:none">
        <label>GeliÅŸmiÅŸ (Teknik Åef / Saha Amir)</label>
        <select id="advancedStatus">
          <option value="">SeÃ§ (opsiyonel)</option>
          <option value="DÄ±ÅŸ Servis Ã‡aÄŸrÄ±lacak">DÄ±ÅŸ Servis Ã‡aÄŸrÄ±lacak</option>
          <option value="DÄ±ÅŸ Servis Ã‡aÄŸrÄ±ldÄ±">DÄ±ÅŸ Servis Ã‡aÄŸrÄ±ldÄ±</option>
          <option value="DÄ±ÅŸ Servis Geldi-OnardÄ±">DÄ±ÅŸ Servis Geldi / OnardÄ±</option>
          <option value="Teklif Bekleniyor">Teklif Bekleniyor</option>
          <option value="Teklif AlÄ±ndÄ±">Teklif AlÄ±ndÄ±</option>
          <option value="ParÃ§a Bekleniyor">ParÃ§a Bekleniyor</option>
        </select>
        <div class="hint">Bu alanÄ± personel gÃ¶rmez. Teknik Åef yoksa Saha Amir devralÄ±r.</div>
      </div>

      <label>Not / AÃ§Ä±klama</label>
      <textarea id="statusNote" placeholder="Ã–rn: Lamba deÄŸiÅŸti, foto eklendi / YarÄ±n saat 10:00 planlandÄ±"></textarea>

      <label>FotoÄŸraf (opsiyonel) - 1 adet</label>
      <input id="statusPhoto" type="file" accept="image/*" />
      <div class="files" id="statusFileList"></div>

      <div class="sep"></div>
      <button class="btn2" id="updateBtn">Durumu Kaydet</button>
      <div id="updateMsg" class="msg" style="display:none"></div>

      <div class="pillbar">
        <span class="pill">ğŸ“© 17:00 yapÄ±lmayanlar (mail)</span>
        <span class="pill">ğŸ•› 00:00 gÃ¼nlÃ¼k rapor (mail)</span>
        <span class="pill">â±ï¸ 24 saat SLA uyarÄ±</span>
      </div>
      <div class="hint">Mail/rapor/SLA tarafÄ± Apps Scriptâ€™te tetikleyicilerle Ã§alÄ±ÅŸÄ±r. Bu sayfa sadece veri gÃ¶nderir.</div>
    </div>
  </div>
</div>

<script>
/** =========================
 *  AYARLAR
 *  ========================= */
const API_URL = "https://script.google.com/macros/s/AKfycby0A6mQvJEK9VadLhAhUoiIk2xmDTsVIYT7zbulE7ZKXe24fwnA1bohLuKebV6c1ixulw/exec";

/**
 * Rol bazlÄ± geliÅŸmiÅŸ izin:
 * - Teknik Åef
 * - Saha Sorumlusu / Saha Amir (senin modelin)
 */
const ADVANCED_ROLES = new Set([
  "Teknik Åef",
  "Saha Sorumlusu",
  "Saha Amir",
  "Saha Amiri",
  "YÃ¶netim"
]);

/** =========================
 *  OTURUM (login.html tarafÄ±nda localStorage'a yazÄ±ldÄ±ÄŸÄ± varsayÄ±mÄ±)
 *  Beklenen anahtarlar:
 *  - se_user_name
 *  - se_user_role
 *  - se_user_unit
 *  ========================= */
function getSession(){
  const name = localStorage.getItem("se_user_name") || "Bilinmiyor";
  const role = localStorage.getItem("se_user_role") || "Personel";
  const unit = localStorage.getItem("se_user_unit") || "";
  return { name, role, unit };
}

function setWhoChip(){
  const s = getSession();
  document.getElementById("whoChip").textContent = ğŸ‘¤ Oturum: ${s.name} (${s.role});
  // geliÅŸmiÅŸ kutu
  const adv = document.getElementById("advancedBox");
  if (ADVANCED_ROLES.has(s.role)) adv.style.display = "block";
}

setWhoChip();

/** =========================
 *  FOTOÄRAF KÃœÃ‡ÃœLTME (mobil iÃ§in)
 *  - maxEdge: 1280
 *  - kalite: 0.8
 *  ========================= */
function fileToResizedDataUrl(file, maxEdge=1280, quality=0.8){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("Dosya okunamadÄ±"));
    reader.onload = () => {
      const img = new Image();
      img.onerror = () => reject(new Error("GÃ¶rsel okunamadÄ±"));
      img.onload = () => {
        let { width:w, height:h } = img;
        const scale = Math.min(1, maxEdge / Math.max(w,h));
        const nw = Math.round(w * scale);
        const nh = Math.round(h * scale);

        const canvas = document.createElement("canvas");
        canvas.width = nw;
        canvas.height = nh;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, nw, nh);

        const dataUrl = canvas.toDataURL("image/jpeg", quality);
        resolve(dataUrl);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

function showFiles(inputEl, listEl, max=3){
  const files = Array.from(inputEl.files || []);
  listEl.innerHTML = "";
  files.slice(0,max).forEach(f=>{
    const div = document.createElement("div");
    div.className = "fileItem";
    div.textContent = â€¢ ${f.name};
    listEl.appendChild(div);
  });
  if(files.length > max){
    const div = document.createElement("div");
    div.className = "fileItem";
    div.innerHTML = <span class="danger">â€¢ En fazla ${max} dosya gÃ¶nderilir. FazlasÄ± yok sayÄ±lÄ±r.</span>;
    listEl.appendChild(div);
  }
}

document.getElementById("photos").addEventListener("change", e=>{
  showFiles(e.target, document.getElementById("fileList"), 3);
});
document.getElementById("statusPhoto").addEventListener("change", e=>{
  showFiles(e.target, document.getElementById("statusFileList"), 1);
});

/** =========================
 *  API Ã§aÄŸrÄ±sÄ± (JSON POST)
 *  ========================= */
async function postJSON(payload){
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  // Apps Script bazen HTML dÃ¶ndÃ¼rÃ¼rse hata yakalayalÄ±m
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); }
  catch(e){ throw new Error("Sunucu JSON dÃ¶ndÃ¼rmedi: " + text.slice(0,120)); }
  if(!data.ok) throw new Error(data.error || "Bilinmeyen hata");
  return data;
}

function showMsg(el, type, text){
  el.style.display = "block";
  el.className = "msg " + (type || "");
  el.textContent = text;
}

/** =========================
 *  1) TESPÄ°T GÃ–NDER
 *  ========================= */
document.getElementById("sendBtn").addEventListener("click", async ()=>{
  const msgEl = document.getElementById("sendMsg");
  msgEl.style.display = "none";

  const s = getSession();
  const targetUnit = document.getElementById("targetUnit").value;
  const priority = document.getElementById("priority").value;
  const title = document.getElementById("title").value.trim();
  const location = document.getElementById("location").value.trim();
  const desc = document.getElementById("desc").value.trim();

  if(!title || !desc){
    showMsg(msgEl, "warn", "BaÅŸlÄ±k ve aÃ§Ä±klama zorunlu.");
    return;
  }

  const files = Array.from(document.getElementById("photos").files || []).slice(0,3);

  try{
    showMsg(msgEl, "", "GÃ¶nderiliyorâ€¦");

    const photos = [];
    for(const f of files){
      const dataUrl = await fileToResizedDataUrl(f);
      photos.push({ name: f.name, dataUrl }); // base64 dataUrl
    }

    const payload = {
      action: "createCase",
      createdAt: new Date().toISOString(),
      createdBy: { name: s.name, role: s.role, unit: s.unit },
      targetUnit,
      priority,
      title,
      location,
      desc,
      photos
    };

    const data = await postJSON(payload);
    const caseId = data.caseId || data.id || "(id dÃ¶nmedi)";

    showMsg(msgEl, "ok", âœ… Tespit kaydedildi. ID: ${caseId});
    // form sÄ±fÄ±rla
    document.getElementById("title").value = "";
    document.getElementById("location").value = "";
    document.getElementById("desc").value = "";
    document.getElementById("photos").value = "";
    document.getElementById("fileList").innerHTML = "";
    // ID'yi saÄŸ tarafa da yaz
    document.getElementById("caseId").value = caseId;

  }catch(err){
    showMsg(msgEl, "bad", "âŒ Hata: " + err.message);
  }
});

/** =========================
 *  2) DURUM GÃœNCELLE
 *  ========================= */
document.getElementById("updateBtn").addEventListener("click", async ()=>{
  const msgEl = document.getElementById("updateMsg");
  msgEl.style.display = "none";

  const s = getSession();
  const caseId = document.getElementById("caseId").value.trim();
  const caseUnit = document.getElementById("caseUnit").value;
  const status = document.getElementById("status").value;
  const advancedStatus = (document.getElementById("advancedStatus").value || "").trim();
  const note = document.getElementById("statusNote").value.trim();

  if(!caseId){
    showMsg(msgEl, "warn", "Tespit ID girmen lazÄ±m (yoksa Ã¶nce tespit oluÅŸtur).");
    return;
  }

  // geliÅŸmiÅŸ statÃ¼ yetki kontrolÃ¼
  if(advancedStatus && !ADVANCED_ROLES.has(s.role)){
    showMsg(msgEl, "bad", "Bu geliÅŸmiÅŸ seÃ§enek sadece Teknik Åef / Saha Amir iÃ§in aÃ§Ä±k.");
    return;
  }

  const file = (document.getElementById("statusPhoto").files || [])[0];

  try{
    showMsg(msgEl, "", "Kaydediliyorâ€¦");

    let photo = null;
    if(file){
      const dataUrl = await fileToResizedDataUrl(file);
      photo = { name:file.name, dataUrl };
    }

    const payload = {
      action: "updateCase",
      updatedAt: new Date().toISOString(),
      updatedBy: { name: s.name, role: s.role, unit: s.unit },
      caseId,
      caseUnit,
      status,
      advancedStatus,
      note,
      photo
    };

    const data = await postJSON(payload);
    showMsg(msgEl, "ok", "âœ… Durum kaydedildi.");
    document.getElementById("statusNote").value = "";
    document.getElementById("statusPhoto").value = "";
    document.getElementById("statusFileList").innerHTML = "";

  }catch(err){
    showMsg(msgEl, "bad", "âŒ Hata: " + err.message);
  }
});
</script>
</body>
</html>
